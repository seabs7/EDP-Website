<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equipment Design & Planning Inc.</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css">
<script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
<script>
  window.APS_API_BASE = 'https://edp-aps-server.onrender.com';
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --navy: #0d1b3e;
    --navy-mid: #162449;
    --navy-light: #1e3264;
    --silver: #c8cdd6;
    --silver-light: #e8ebf0;
    --white: #f5f7fa;
    --accent: #4a7fd4;
    --accent2: #a8b8d8;
    --text: #1a1f2e;
    --muted: #5c6478;
    --border: #d0d5e0;
    --green: #27ae60;
    --orange: #e67e22;
    --red: #c0392b;
    --yellow: #f39c12;
  }
  body { font-family: 'Barlow', sans-serif; background: var(--white); color: var(--text); min-height: 100vh; }

  /* ======= LOGIN SCREEN ======= */
  .login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 60%, #2a4a8a 100%); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 24px; }
  .login-screen.hidden { display: none; }
  .login-box { background: white; border-radius: 16px; width: 100%; max-width: 460px; overflow: hidden; box-shadow: 0 32px 80px rgba(0,0,0,0.4); animation: slideUp 0.3s ease; }
  .login-header { background: var(--navy); padding: 32px 36px 24px; text-align: center; }
  .login-logo-main { font-family: 'Barlow Condensed', sans-serif; font-weight: 800; font-size: 26px; color: white; letter-spacing: 0.04em; text-transform: uppercase; }
  .login-logo-sub { font-size: 11px; letter-spacing: 0.15em; color: var(--accent2); text-transform: uppercase; margin-bottom: 20px; }
  .login-tabs { display: flex; gap: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 4px; }
  .login-tab { flex: 1; padding: 8px; border: none; background: transparent; color: var(--accent2); font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
  .login-tab.active { background: white; color: var(--navy); }
  .login-body { padding: 32px 36px; }
  .login-body h3 { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 700; color: var(--navy); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 6px; }
  .login-body p { font-size: 13px; color: var(--muted); margin-bottom: 24px; }
  .login-field { margin-bottom: 16px; }
  .login-field label { display: block; font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .login-field input { width: 100%; padding: 11px 16px; border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text); background: var(--silver-light); outline: none; transition: border-color 0.2s; }
  .login-field input:focus { border-color: var(--navy); background: white; }
  .login-error { background: #fdf0ef; border: 1px solid #f5c6c2; color: var(--red); padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-bottom: 14px; display: none; }
  .login-error.show { display: block; }
  .login-btn { width: 100%; background: var(--navy); color: white; border: none; padding: 13px; font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin-top: 4px; }
  .login-btn:hover { background: var(--accent); }
  .login-hint { margin-top: 16px; padding: 12px 14px; background: var(--silver-light); border-radius: 6px; font-size: 12px; color: var(--muted); line-height: 1.6; }
  .login-hint strong { color: var(--navy); }
  .login-guest { text-align: center; margin-top: 14px; }
  .login-guest button { background: none; border: none; color: var(--accent); font-family: 'Barlow', sans-serif; font-size: 13px; cursor: pointer; text-decoration: underline; }

  /* ======= TOP BAR ======= */
  .topbar { background: var(--navy); color: var(--silver-light); text-align: center; font-size: 13px; padding: 8px 20px; letter-spacing: 0.05em; }
  header { background: var(--white); border-bottom: 2px solid var(--navy); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 12px rgba(13,27,62,0.08); }
  .header-inner { max-width: 1300px; margin: 0 auto; padding: 0 24px; display: flex; align-items: center; gap: 24px; height: 72px; }
  .logo { display: flex; flex-direction: column; line-height: 1; text-decoration: none; }
  .logo-main { font-family: 'Barlow Condensed', sans-serif; font-weight: 800; font-size: 22px; color: var(--navy); letter-spacing: 0.04em; text-transform: uppercase; }
  .logo-sub { font-size: 10px; letter-spacing: 0.15em; color: var(--muted); text-transform: uppercase; }
  .header-search { flex: 1; max-width: 460px; margin: 0 auto; position: relative; }
  .header-search input { width: 100%; padding: 10px 44px 10px 16px; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-size: 14px; background: var(--silver-light); color: var(--text); outline: none; transition: border-color 0.2s; }
  .header-search input:focus { border-color: var(--navy); }
  .header-search .search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--muted); font-size: 16px; }
  .header-actions { display: flex; align-items: center; gap: 12px; }
  .header-actions button, .header-actions a { background: none; border: none; cursor: pointer; color: var(--navy); font-family: 'Barlow', sans-serif; font-size: 13px; font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 2px; text-decoration: none; transition: color 0.2s; }
  .header-actions button:hover, .header-actions a:hover { color: var(--accent); }
  .header-actions .icon { font-size: 20px; }
  .cart-btn { position: relative; }
  .cart-badge { position: absolute; top: -4px; right: -8px; background: var(--accent); color: white; font-size: 10px; font-weight: 700; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .user-pill { display: flex; align-items: center; gap: 8px; background: var(--silver-light); border: 1.5px solid var(--border); border-radius: 20px; padding: 5px 14px 5px 8px; cursor: pointer; transition: all 0.2s; flex-direction: row !important; }
  .user-pill:hover { border-color: var(--navy); }
  .user-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; color: white; flex-shrink: 0; }
  .user-avatar.admin { background: var(--accent); }
  .user-avatar.customer { background: var(--green); }
  .user-name { font-size: 13px; font-weight: 600; color: var(--navy); white-space: nowrap; }
  .user-role-badge { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.06em; }
  .user-role-badge.admin { background: rgba(74,127,212,0.15); color: var(--accent); }
  .user-role-badge.customer { background: rgba(39,174,96,0.15); color: var(--green); }

  /* ======= NAV ======= */
  nav { background: var(--navy); }
  .nav-inner { max-width: 1300px; margin: 0 auto; padding: 0 24px; display: flex; gap: 0; flex-wrap: wrap; }
  .nav-inner a { color: var(--silver-light); text-decoration: none; font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; padding: 12px 18px; transition: background 0.2s, color 0.2s; border-bottom: 3px solid transparent; cursor: pointer; }
  .nav-inner a:hover, .nav-inner a.active { background: var(--navy-light); color: white; border-bottom-color: var(--accent); }
  .nav-inner a.portal-link { margin-left: auto; color: var(--accent2); }
  .nav-inner a.portal-link:hover { color: white; }

  /* ======= HERO ======= */
  .hero { background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 60%, #2a4a8a 100%); color: white; padding: 80px 24px; text-align: center; position: relative; overflow: hidden; }
  .hero::before { content: ''; position: absolute; inset: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
  .hero-content { position: relative; max-width: 800px; margin: 0 auto; }
  .hero h1 { font-family: 'Barlow Condensed', sans-serif; font-size: 64px; font-weight: 800; letter-spacing: 0.02em; line-height: 1; margin-bottom: 16px; text-transform: uppercase; }
  .hero h1 span { color: #6fa3e8; }
  .hero p { font-size: 18px; font-weight: 300; color: var(--accent2); margin-bottom: 32px; }
  .hero-btns { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
  .btn-primary { background: var(--accent); color: white; border: none; padding: 14px 32px; font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: background 0.2s, transform 0.1s; }
  .btn-primary:hover { background: #3a6fc4; transform: translateY(-1px); }
  .btn-outline { background: transparent; color: white; border: 2px solid rgba(255,255,255,0.4); padding: 14px 32px; font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
  .btn-outline:hover { border-color: white; background: rgba(255,255,255,0.1); }
  .page { max-width: 1300px; margin: 0 auto; padding: 40px 24px; }
  .section-header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 28px; border-bottom: 2px solid var(--navy); padding-bottom: 12px; }
  .section-title { font-family: 'Barlow Condensed', sans-serif; font-size: 32px; font-weight: 800; color: var(--navy); text-transform: uppercase; letter-spacing: 0.04em; }

  /* ======= PRODUCTS ======= */
  .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; }
  .product-card { background: white; border: 1.5px solid var(--border); border-radius: 10px; overflow: hidden; cursor: pointer; transition: box-shadow 0.2s, transform 0.2s; position: relative; }
  .product-card:hover { box-shadow: 0 8px 32px rgba(13,27,62,0.14); transform: translateY(-3px); }
  .product-img { width: 100%; aspect-ratio: 4/3; background: var(--silver-light); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
  .product-img img { width: 100%; height: 100%; object-fit: cover; }
  .product-img .placeholder-icon { font-size: 52px; color: var(--muted); }
  .product-badge { position: absolute; top: 12px; left: 12px; background: var(--navy); color: white; font-size: 11px; font-weight: 700; letter-spacing: 0.08em; padding: 4px 10px; border-radius: 4px; text-transform: uppercase; }
  .product-badge.sale { background: #c0392b; }
  .admin-product-controls { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; }
  .admin-edit-btn, .admin-del-btn { border: none; border-radius: 6px; padding: 5px 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .admin-edit-btn { background: rgba(74,127,212,0.9); color: white; }
  .admin-edit-btn:hover { background: var(--accent); }
  .admin-del-btn { background: rgba(192,57,43,0.9); color: white; }
  .admin-del-btn:hover { background: var(--red); }
  .product-info { padding: 16px; }
  .product-category { font-size: 11px; letter-spacing: 0.12em; color: var(--accent); text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
  .product-name { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 6px; line-height: 1.2; }
  .product-desc { font-size: 13px; color: var(--muted); line-height: 1.5; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .product-footer { display: flex; align-items: center; justify-content: space-between; }
  .product-price { font-family: 'Barlow Condensed', sans-serif; font-size: 24px; font-weight: 700; color: var(--navy); }
  .add-to-cart { background: var(--navy); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-family: 'Barlow', sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
  .add-to-cart:hover { background: var(--accent); }

  /* ======= FILTER ======= */
  .filter-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 28px; align-items: center; }
  .filter-label { font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
  .filter-chip { padding: 6px 16px; border: 1.5px solid var(--border); border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; background: white; color: var(--text); transition: all 0.2s; }
  .filter-chip:hover, .filter-chip.active { background: var(--navy); color: white; border-color: var(--navy); }
  .filter-right { margin-left: auto; }
  .sort-select { padding: 7px 14px; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-size: 13px; color: var(--text); background: white; cursor: pointer; outline: none; }
  .categories-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; margin-bottom: 48px; }
  .cat-card { background: var(--navy); color: white; border-radius: 10px; padding: 24px 16px; text-align: center; cursor: pointer; transition: background 0.2s, transform 0.2s; }
  .cat-card:hover { background: var(--navy-light); transform: translateY(-2px); }
  .cat-card .cat-icon { font-size: 32px; margin-bottom: 8px; }
  .cat-card .cat-name { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--silver-light); }

  /* ======= MODALS ======= */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center; padding: 24px; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.25s ease; }
  @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-header { background: var(--navy); color: white; padding: 20px 28px; display: flex; align-items: center; justify-content: space-between; border-radius: 12px 12px 0 0; position: sticky; top: 0; z-index: 10; }
  .modal-title { font-family: 'Barlow Condensed', sans-serif; font-size: 24px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
  .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1; opacity: 0.7; transition: opacity 0.2s; }
  .modal-close:hover { opacity: 1; }
  .modal-body { padding: 28px; }
  .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
  @media (max-width: 640px) { .modal-grid { grid-template-columns: 1fr; } }
  .modal-main-img { width: 100%; aspect-ratio: 4/3; background: var(--silver-light); border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 72px; color: var(--muted); border: 1.5px solid var(--border); margin-bottom: 12px; }
  .modal-main-img img { width: 100%; height: 100%; object-fit: cover; }
  .modal-thumbs { display: flex; gap: 8px; }
  .modal-thumb { width: 60px; height: 60px; border-radius: 6px; border: 2px solid var(--border); background: var(--silver-light); cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--muted); transition: border-color 0.2s; }
  .modal-thumb.active, .modal-thumb:hover { border-color: var(--navy); }
  .modal-thumb img { width: 100%; height: 100%; object-fit: cover; }
  .modal-cat { color: var(--accent); font-size: 12px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 6px; }
  .modal-info h2 { font-family: 'Barlow Condensed', sans-serif; font-size: 30px; font-weight: 800; color: var(--navy); margin-bottom: 4px; line-height: 1.1; text-transform: uppercase; }
  .modal-price { font-family: 'Barlow Condensed', sans-serif; font-size: 38px; font-weight: 700; color: var(--navy); margin-bottom: 14px; line-height: 1; }
  .modal-desc { font-size: 14px; color: var(--muted); line-height: 1.7; margin-bottom: 18px; }
  .modal-specs { background: var(--silver-light); border-radius: 8px; padding: 16px; margin-bottom: 18px; }
  .modal-specs h4 { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--navy); margin-bottom: 10px; }
  .spec-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .spec-row:last-child { border-bottom: none; }
  .spec-key { color: var(--muted); font-weight: 500; }
  .spec-val { color: var(--text); font-weight: 600; text-align: right; max-width: 60%; }
  .modal-actions { display: flex; gap: 12px; flex-wrap: wrap; }
  .modal-actions .btn-primary { flex: 1; font-size: 15px; }
  .spec-sheet-btn { background: white; color: var(--navy); border: 2px solid var(--navy); padding: 10px 18px; font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
  .spec-sheet-btn:hover { background: var(--navy); color: white; }

  /* ======= ADMIN DASHBOARD ======= */
  .dashboard-page { display: none; }
  .dashboard-page.active { display: block; }
  .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
  .dash-title { font-family: 'Barlow Condensed', sans-serif; font-size: 36px; font-weight: 800; color: var(--navy); text-transform: uppercase; letter-spacing: 0.04em; }
  .dash-welcome { font-size: 14px; color: var(--muted); margin-top: 2px; }
  .stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .stat-card { background: white; border: 1.5px solid var(--border); border-radius: 10px; padding: 20px; }
  .stat-card .stat-icon { font-size: 28px; margin-bottom: 8px; }
  .stat-card .stat-val { font-family: 'Barlow Condensed', sans-serif; font-size: 32px; font-weight: 800; color: var(--navy); line-height: 1; margin-bottom: 4px; }
  .stat-card .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }

  /* ======= ADMIN PANEL (add/edit product) ======= */
  .admin-panel { display: none; background: white; border: 2px solid var(--navy); border-radius: 12px; padding: 32px; margin: 40px 0 0; box-shadow: 0 8px 40px rgba(13,27,62,0.12); }
  .admin-panel.open { display: block; }
  .admin-panel h2 { font-family: 'Barlow Condensed', sans-serif; font-size: 28px; font-weight: 800; color: var(--navy); text-transform: uppercase; margin-bottom: 24px; letter-spacing: 0.04em; border-bottom: 2px solid var(--silver-light); padding-bottom: 12px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }
  .form-group label { font-size: 12px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
  .form-group input, .form-group textarea, .form-group select { padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text); background: var(--silver-light); outline: none; transition: border-color 0.2s; }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--navy); background: white; }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .spec-builder { grid-column: 1 / -1; }
  .spec-builder > label { font-size: 12px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); display: block; margin-bottom: 8px; }
  .spec-row-input { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
  .spec-row-input input { flex: 1; padding: 8px 12px; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'Barlow', sans-serif; font-size: 13px; background: var(--silver-light); outline: none; }
  .spec-row-input input:focus { border-color: var(--navy); background: white; }
  .remove-spec { background: none; border: none; color: #c0392b; font-size: 18px; cursor: pointer; padding: 4px; line-height: 1; }
  .add-spec-btn { background: none; border: 1.5px dashed var(--border); padding: 8px 16px; border-radius: 6px; font-size: 13px; color: var(--muted); cursor: pointer; transition: border-color 0.2s, color 0.2s; font-family: 'Barlow', sans-serif; }
  .add-spec-btn:hover { border-color: var(--navy); color: var(--navy); }
  .img-upload-area { grid-column: 1 / -1; border: 2px dashed var(--border); border-radius: 8px; padding: 32px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; background: var(--silver-light); }
  .img-upload-area:hover { border-color: var(--navy); background: white; }
  .img-upload-area p { color: var(--muted); font-size: 14px; margin-top: 8px; }
  .img-upload-area .upload-icon { font-size: 36px; }
  .img-upload-area input[type=file] { display: none; }
  .img-preview-strip { grid-column: 1 / -1; display: flex; gap: 10px; flex-wrap: wrap; }
  .img-preview { width: 80px; height: 80px; border-radius: 6px; border: 2px solid var(--border); overflow: hidden; position: relative; }
  .img-preview img { width: 100%; height: 100%; object-fit: cover; }
  .img-preview .del-img { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
  .form-actions { grid-column: 1 / -1; display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; }
  .btn-cancel { background: white; color: var(--muted); border: 1.5px solid var(--border); padding: 10px 24px; font-family: 'Barlow', sans-serif; font-size: 14px; border-radius: 6px; cursor: pointer; }
  .btn-save { background: var(--accent); color: white; border: none; padding: 10px 28px; font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
  .btn-save:hover { background: #3a6fc4; }

  /* ======= ORDERS TABLE (Admin) ======= */
  .table-wrap { background: white; border: 1.5px solid var(--border); border-radius: 10px; overflow: hidden; margin-top: 32px; }
  .table-head { background: var(--navy); color: white; display: grid; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 12px 20px; }
  .table-head.orders-cols { grid-template-columns: 80px 1fr 120px 100px 130px 140px; }
  .table-head.customers-cols { grid-template-columns: 60px 1fr 180px 90px 120px; }
  .table-row { display: grid; padding: 14px 20px; border-bottom: 1px solid var(--border); align-items: center; font-size: 13px; transition: background 0.15s; }
  .table-row:hover { background: var(--silver-light); }
  .table-row:last-child { border-bottom: none; }
  .table-row.orders-cols { grid-template-columns: 80px 1fr 120px 100px 130px 140px; }
  .table-row.customers-cols { grid-template-columns: 60px 1fr 180px 90px 120px; }
  .status-pill { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; }
  .status-pill.processing { background: rgba(243,156,18,0.15); color: var(--yellow); }
  .status-pill.shipped { background: rgba(74,127,212,0.15); color: var(--accent); }
  .status-pill.delivered { background: rgba(39,174,96,0.15); color: var(--green); }
  .status-pill.pending { background: rgba(192,57,43,0.1); color: var(--red); }
  .status-pill.warranty { background: rgba(142,68,173,0.15); color: #8e44ad; }
  .order-num { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; color: var(--navy); font-size: 14px; }
  .table-action-btn { background: var(--silver-light); border: 1px solid var(--border); padding: 4px 10px; border-radius: 5px; font-size: 12px; font-weight: 600; color: var(--navy); cursor: pointer; transition: all 0.2s; }
  .table-action-btn:hover { background: var(--navy); color: white; }

  /* ======= CUSTOMER PORTAL ======= */
  .portal-section { margin-bottom: 40px; }
  .portal-section-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 800; color: var(--navy); text-transform: uppercase; letter-spacing: 0.04em; border-bottom: 2px solid var(--silver-light); padding-bottom: 10px; margin-bottom: 20px; }
  .order-card { background: white; border: 1.5px solid var(--border); border-radius: 10px; padding: 20px 24px; margin-bottom: 14px; transition: box-shadow 0.2s; }
  .order-card:hover { box-shadow: 0 4px 20px rgba(13,27,62,0.1); }
  .order-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
  .order-id { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 700; color: var(--navy); }
  .order-date { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .order-items-list { font-size: 13px; color: var(--muted); margin-bottom: 12px; line-height: 1.6; }
  .order-total-row { display: flex; justify-content: space-between; font-size: 14px; font-weight: 600; color: var(--navy); padding-top: 10px; border-top: 1px solid var(--border); }
  .tracking-box { background: var(--silver-light); border-radius: 8px; padding: 16px; margin-top: 14px; display: none; }
  .tracking-box.open { display: block; }
  .tracking-number { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent); letter-spacing: 0.05em; }
  .tracking-steps { margin-top: 16px; }
  .tracking-step { display: flex; align-items: flex-start; gap: 14px; margin-bottom: 12px; }
  .step-dot { width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; margin-top: 2px; }
  .step-dot.done { background: var(--green); }
  .step-dot.active { background: var(--accent); }
  .step-dot.pending { background: var(--border); }
  .step-info .step-label { font-size: 13px; font-weight: 600; color: var(--navy); }
  .step-info .step-date { font-size: 12px; color: var(--muted); }
  .warranty-card { background: white; border: 1.5px solid var(--border); border-radius: 10px; padding: 20px 24px; margin-bottom: 14px; }
  .warranty-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .warranty-product { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; color: var(--navy); }
  .warranty-details { font-size: 13px; color: var(--muted); line-height: 1.6; }
  .warranty-bar-wrap { margin-top: 12px; }
  .warranty-bar-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
  .warranty-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .warranty-fill { height: 100%; border-radius: 4px; background: var(--green); transition: width 0.6s ease; }
  .warranty-fill.expiring { background: var(--yellow); }
  .warranty-fill.expired { background: var(--red); }
  .portal-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
  .portal-btn { background: var(--silver-light); border: 1px solid var(--border); padding: 7px 14px; border-radius: 6px; font-size: 13px; font-weight: 600; color: var(--navy); cursor: pointer; transition: all 0.2s; font-family: 'Barlow', sans-serif; }
  .portal-btn:hover { background: var(--navy); color: white; }
  .portal-btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
  .portal-btn.primary:hover { background: #3a6fc4; }

  /* ======= CART ======= */
  .cart-drawer { position: fixed; right: 0; top: 0; bottom: 0; width: 380px; max-width: 100vw; background: white; box-shadow: -4px 0 40px rgba(0,0,0,0.2); z-index: 300; transform: translateX(100%); transition: transform 0.3s ease; display: flex; flex-direction: column; }
  .cart-drawer.open { transform: translateX(0); }
  .cart-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 290; display: none; }
  .cart-overlay.open { display: block; }
  .cart-head { background: var(--navy); color: white; padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; }
  .cart-head h3 { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; }
  .cart-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
  .cart-close:hover { opacity: 1; }
  .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
  .cart-empty { text-align: center; color: var(--muted); padding: 48px 0; font-size: 15px; }
  .cart-item { display: flex; gap: 14px; padding: 14px 0; border-bottom: 1px solid var(--border); align-items: flex-start; }
  .cart-item-img { width: 64px; height: 64px; border-radius: 6px; background: var(--silver-light); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; overflow: hidden; }
  .cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
  .cart-item-info { flex: 1; }
  .cart-item-name { font-weight: 600; font-size: 14px; color: var(--navy); margin-bottom: 4px; }
  .cart-item-price { font-size: 13px; color: var(--muted); }
  .cart-item-remove { background: none; border: none; color: #c0392b; font-size: 18px; cursor: pointer; line-height: 1; }
  .cart-foot { padding: 20px; border-top: 2px solid var(--border); }
  .cart-total { display: flex; justify-content: space-between; font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 700; color: var(--navy); margin-bottom: 16px; }
  .checkout-btn { width: 100%; background: var(--navy); color: white; border: none; padding: 14px; font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
  .checkout-btn:hover { background: var(--accent); }

  /* ======= FOOTER ======= */
  footer { background: var(--navy); color: var(--silver-light); margin-top: 64px; padding: 48px 24px 24px; }
  .footer-inner { max-width: 1300px; margin: 0 auto; }
  .footer-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 40px; margin-bottom: 32px; }
  @media (max-width: 700px) { .footer-grid { grid-template-columns: 1fr 1fr; } }
  .footer-brand p { font-size: 13px; color: var(--accent2); margin-top: 12px; line-height: 1.6; }
  .footer-brand .logo-main { color: white; font-size: 20px; }
  .footer-brand .logo-sub { color: var(--accent2); }
  .footer-col h4 { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: white; margin-bottom: 14px; }
  .footer-col a { display: block; color: var(--accent2); text-decoration: none; font-size: 13px; margin-bottom: 8px; transition: color 0.2s; }
  .footer-col a:hover { color: white; }
  .footer-bottom { border-top: 1px solid var(--navy-light); padding-top: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--accent2); flex-wrap: wrap; gap: 8px; }
  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--navy); color: white; padding: 14px 22px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 400; transform: translateY(80px); opacity: 0; transition: all 0.3s ease; border-left: 4px solid var(--accent); pointer-events: none; max-width: 320px; }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* ======= CONFIRM DIALOG ======= */
  .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 500; display: none; align-items: center; justify-content: center; }
  .confirm-overlay.open { display: flex; }
  .confirm-box { background: white; border-radius: 12px; padding: 32px; max-width: 380px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.2s ease; }
  .confirm-box h3 { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 800; color: var(--navy); text-transform: uppercase; margin-bottom: 10px; }
  .confirm-box p { font-size: 14px; color: var(--muted); margin-bottom: 24px; }
  .confirm-btns { display: flex; gap: 12px; justify-content: center; }
  .confirm-cancel { background: white; border: 1.5px solid var(--border); color: var(--muted); padding: 9px 22px; border-radius: 6px; font-family: 'Barlow', sans-serif; font-size: 14px; cursor: pointer; }
  .confirm-delete { background: var(--red); color: white; border: none; padding: 9px 22px; border-radius: 6px; font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; }

  /* ======= ADMIN TABS ======= */
  .admin-tabs { display: flex; gap: 4px; background: var(--silver-light); border-radius: 8px; padding: 4px; margin-bottom: 28px; width: fit-content; }
  .admin-tab-btn { padding: 8px 20px; border: none; background: transparent; color: var(--muted); font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
  .admin-tab-btn.active { background: var(--navy); color: white; }

  /* ======= CONFIGURATOR ======= */
  .configurator-container { display: grid; grid-template-columns: 1fr 380px; gap: 32px; max-width: 1400px; margin: 0 auto; padding: 40px 24px; }
  .config-canvas-wrap { position: relative; }
  .controls-hint { position: static; display: inline-block; margin: 0 0 8px; background: rgba(255,255,255,0.85); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; font-size: 11px; color: var(--muted); letter-spacing: 0.02em; box-shadow: 0 4px 12px rgba(13,27,62,0.08); }
  #apsViewer { width: 100%; aspect-ratio: 1; background: #f5f5f0; border-radius: 12px; border: 2px solid var(--border); box-shadow: 0 8px 32px rgba(13,27,62,0.1); overflow: hidden; }
  #configuratorCanvas { display: none; }
  .controls-hint { position: absolute; left: 12px; bottom: 12px; background: rgba(255,255,255,0.85); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; font-size: 11px; color: var(--muted); letter-spacing: 0.02em; box-shadow: 0 4px 12px rgba(13,27,62,0.08); }
  .config-panel { background: white; border-radius: 12px; border: 2px solid var(--border); padding: 24px; box-shadow: 0 4px 16px rgba(13,27,62,0.08); }
  .config-section { margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
  .config-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .config-label { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--navy); margin-bottom: 12px; display: block; }
  .config-select, .config-select-group { width: 100%; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text); background: var(--white); cursor: pointer; outline: none; transition: border-color 0.2s; margin-bottom: 8px; }
  .config-select:focus { border-color: var(--navy); }
  .config-button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
  .config-btn { padding: 10px 12px; border: 1.5px solid var(--border); border-radius: 8px; background: white; color: var(--text); font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.05em; }
  .config-btn:hover { border-color: var(--navy); color: var(--navy); }
  .config-btn.active { background: var(--navy); color: white; border-color: var(--navy); }
  .color-picker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 8px; }
  .color-swatch { width: 100%; aspect-ratio: 1; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  .color-swatch:hover { transform: scale(1.05); }
  .color-swatch.active { border-color: var(--navy); box-shadow: 0 0 0 3px rgba(74,127,212,0.2); }
  .ral-color-input { display: flex; gap: 8px; }
  .ral-color-input input { flex: 1; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px; font-family: 'Barlow', sans-serif; }
  .ral-color-input button { padding: 10px 16px; background: var(--navy); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap; }
  .ral-color-input button:hover { background: var(--accent); }
  .config-info { background: var(--silver-light); border-radius: 8px; padding: 14px; font-size: 13px; color: var(--text); line-height: 1.5; margin-bottom: 8px; }
  .price-display { background: rgba(74,127,212,0.08); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: center; }
  .price-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
  .price-value { font-family: 'Barlow Condensed', sans-serif; font-size: 28px; font-weight: 700; color: var(--navy); }
  .leadtime-display { background: rgba(39,174,96,0.08); border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: center; }
  .leadtime-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
  .leadtime-value { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 700; color: var(--green); }
  .save-config-btn { width: 100%; padding: 14px; background: var(--navy); color: white; border: none; border-radius: 8px; font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: background 0.2s; margin-bottom: 8px; }
  .save-config-btn:hover { background: var(--accent); }
  .add-to-cart-btn { width: 100%; padding: 14px; background: var(--green); color: white; border: none; border-radius: 8px; font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: background 0.2s; }
  .add-to-cart-btn:hover { background: #1e8449; }

  @media (max-width: 768px) {
    .hero h1 { font-size: 40px; }
    .header-search { display: none; }
    .table-head.orders-cols, .table-row.orders-cols { grid-template-columns: 70px 1fr 100px 90px; }
    .table-head.orders-cols span:nth-child(5), .table-head.orders-cols span:nth-child(6),
    .table-row.orders-cols span:nth-child(5), .table-row.orders-cols span:nth-child(6) { display: none; }
    .configurator-container { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div class="login-screen hidden" id="loginScreen">
  <div class="login-box">
    <div class="login-header">
      <div class="login-logo-main">Equipment Design</div>
      <div class="login-logo-sub">& Planning Inc.</div>
      <div class="login-tabs">
        <button class="login-tab active" id="tabAdmin" onclick="switchLoginTab('admin')">Admin</button>
        <button class="login-tab" id="tabCustomer" onclick="switchLoginTab('customer')">Customer</button>
      </div>
    </div>
    <div class="login-body">
      <div id="loginAdminPane">
        <h3>Admin Login</h3>
        <p>Sign in to manage products, orders, and customers.</p>
        <div class="login-field">
          <label>Username</label>
          <input type="text" id="adminUser" placeholder="Enter admin username" autocomplete="off">
        </div>
        <div class="login-field">
          <label>Password</label>
          <input type="password" id="adminPass" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')doLogin('admin')">
        </div>
        <div class="login-error" id="adminError">Incorrect username or password. Try again.</div>
        <button class="login-btn" onclick="doLogin('admin')">Sign In as Admin</button>
        <div class="login-hint">Demo credentials:<br><strong>Username:</strong> admin &nbsp;|&nbsp; <strong>Password:</strong> edp2024</div>
      </div>
      <div id="loginCustomerPane" style="display:none">
        <h3>Customer Login</h3>
        <p>View your orders, tracking info, and warranty status.</p>
        <div class="login-field">
          <label>Email Address</label>
          <input type="email" id="custEmail" placeholder="you@example.com" autocomplete="off">
        </div>
        <div class="login-field">
          <label>Order Number / Account ID</label>
          <input type="text" id="custOrder" placeholder="e.g. EDP-10042 or your account ID" onkeydown="if(event.key==='Enter')doLogin('customer')">
        </div>
        <div class="login-error" id="custError">Account not found. Check your email and order number.</div>
        <button class="login-btn" onclick="doLogin('customer')">Access My Account</button>
        <div class="login-hint">Demo credentials:<br><strong>Email:</strong> john@greens.com &nbsp;|&nbsp; <strong>Order #:</strong> EDP-10042<br><br><strong>Email:</strong> sarah@citygrill.com &nbsp;|&nbsp; <strong>Order #:</strong> EDP-10039</div>
      </div>
      <div class="login-guest">
        <button onclick="guestBrowse()">Browse as guest (shop only) ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== MAIN SITE ===== -->
<div id="mainSite">

<div class="topbar">üöö Free shipping on orders over $2,500 &nbsp;|&nbsp; Call us: (800) 555-0192 &nbsp;|&nbsp; Mon‚ÄìFri 8am‚Äì6pm EST</div>

<header>
  <div class="header-inner">
    <a class="logo" href="#" onclick="showStorefront()">
      <span class="logo-main">Equipment Design</span>
      <span class="logo-sub">& Planning Inc.</span>
    </a>
    <div class="header-search">
      <input type="text" id="searchInput" placeholder="Search equipment..." oninput="renderProducts(getFiltered())">
      <button class="search-icon">üîç</button>
    </div>
    <div class="header-actions">
      <div id="userPillWrap"></div>
      <button id="adminHeaderBtn" style="display:none" onclick="showAdminDash()">
        <span class="icon">‚öôÔ∏è</span>
        <span>Dashboard</span>
      </button>
      <button id="portalHeaderBtn" style="display:none" onclick="showCustomerPortal()">
        <span class="icon">üì¶</span>
        <span>My Orders</span>
      </button>
      <button id="signInBtn" class="cart-btn" onclick="document.getElementById('loginScreen').classList.remove('hidden');">
        <span class="icon">üîê</span>
        <span>Sign In</span>
      </button>
      <button class="cart-btn" onclick="toggleCart()">
        <span class="icon">üõí</span>
        <span>Cart</span>
        <span class="cart-badge" id="cartBadge">0</span>
      </button>
    </div>
  </div>
</header>

<nav>
  <div class="nav-inner">
    <a href="#" class="active" id="navAll" onclick="showStorefront();setFilter('All',this)">All Equipment</a>
    <a href="#" onclick="showStorefront();setFilter('Cooking',this)">Cooking</a>
    <a href="#" onclick="showStorefront();setFilter('Refrigeration',this)">Refrigeration</a>
    <a href="#" onclick="showStorefront();setFilter('Prep',this)">Prep & Storage</a>
    <a href="#" onclick="showStorefront();setFilter('Ventilation',this)">Ventilation</a>
    <a href="#" onclick="showStorefront();setFilter('Warewashing',this)">Warewashing</a>
    <a href="#" onclick="showStorefront();setFilter('Beverage',this)">Beverage</a>
    <a href="#" id="navPortalLink" class="portal-link" style="display:none"></a>
  </div>
</nav>

<!-- ===== STOREFRONT ===== -->
<div id="storefrontView">
  <div class="hero">
    <div class="hero-content">
      <h1>Professional <span>Restaurant</span><br>Equipment</h1>
      <p>Commercial-grade equipment designed for the demands of modern foodservice operations.</p>
      <div class="hero-btns">
        <button class="btn-primary" onclick="showStorefront();setFilter('All')">Shop All Equipment</button>
        <button class="btn-outline" onclick="showConfigurator()">üé® 3D Configurator</button>
        <button class="btn-outline" id="heroAdminBtn" style="display:none" onclick="showAdminDash()">‚öôÔ∏è Admin Dashboard</button>
        <button class="btn-outline" id="heroPortalBtn" style="display:none" onclick="showCustomerPortal()">üì¶ My Account</button>
      </div>
    </div>
  </div>

  <div class="page">
    <div class="section-header"><span class="section-title">Shop by Category</span></div>
    <div class="categories-row">
      <div class="cat-card" onclick="setFilter('Cooking')"><div class="cat-icon">üî•</div><div class="cat-name">Cooking</div></div>
      <div class="cat-card" onclick="setFilter('Refrigeration')"><div class="cat-icon">‚ùÑÔ∏è</div><div class="cat-name">Refrigeration</div></div>
      <div class="cat-card" onclick="setFilter('Prep')"><div class="cat-icon">üî™</div><div class="cat-name">Prep & Storage</div></div>
      <div class="cat-card" onclick="setFilter('Ventilation')"><div class="cat-icon">üí®</div><div class="cat-name">Ventilation</div></div>
      <div class="cat-card" onclick="setFilter('Warewashing')"><div class="cat-icon">ü´ß</div><div class="cat-name">Warewashing</div></div>
      <div class="cat-card" onclick="setFilter('Beverage')"><div class="cat-icon">‚òï</div><div class="cat-name">Beverage</div></div>
    </div>

    <div class="section-header">
      <span class="section-title" id="sectionTitle">Featured Equipment</span>
      <span id="productCount" style="color:var(--muted);font-size:14px;"></span>
    </div>

    <div class="filter-bar">
      <span class="filter-label">Filter:</span>
      <button class="filter-chip active" onclick="setFilter('All',this)">All</button>
      <button class="filter-chip" onclick="setFilter('Cooking',this)">Cooking</button>
      <button class="filter-chip" onclick="setFilter('Refrigeration',this)">Refrigeration</button>
      <button class="filter-chip" onclick="setFilter('Prep',this)">Prep</button>
      <button class="filter-chip" onclick="setFilter('Ventilation',this)">Ventilation</button>
      <button class="filter-chip" onclick="setFilter('Warewashing',this)">Warewashing</button>
      <button class="filter-chip" onclick="setFilter('Beverage',this)">Beverage</button>
      <div class="filter-right">
        <select class="sort-select" onchange="currentSort=this.value; renderProducts(getFiltered())">
          <option value="default">Sort: Featured</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="name">Name A‚ÄìZ</option>
        </select>
      </div>
    </div>

    <div class="product-grid" id="productGrid"></div>
  </div>
</div>

<!-- ===== CONFIGURATOR ===== -->
<div id="configuratorView" style="display:none">
  <div class="page">
    <div class="section-header">
      <h2 class="section-title">3D Equipment Configurator</h2>
      <button class="btn-primary" onclick="showStorefront()" style="margin-left: auto;">‚Üê Back to Storefront</button>
    </div>
    <div class="configurator-container">
      <div class="config-canvas-wrap">
        <div class="controls-hint">Drag to pan ¬∑ Scroll to zoom ¬∑ Use viewer toolbar</div>
        <div id="apsViewer"></div>
      </div>
      <div class="config-panel">
        <!-- QUICK TEST LOADER -->
        <div class="config-section" style="background:#fff3cd;border:2px dashed #ffc107;border-radius:8px;padding:16px;margin-bottom:16px;">
          <label class="config-label" style="color:#856404;font-size:14px;margin-bottom:8px;">üß™ Quick Test: Load DWG</label>
          <div style="margin-bottom:10px;font-size:13px;color:#856404;line-height:1.4;">Upload your DWG file to view it in Autodesk Viewer (skips admin upload)</div>
          <input type="file" id="testModelInput" accept=".dwg" style="display:none;" onchange="uploadDwgForViewer(event)">
          <button class="config-btn" style="width:100%;background:#ffc107;color:#000;font-weight:600;" onclick="document.getElementById('testModelInput').click()">üìÅ Choose DWG to Test</button>
          <div id="testStatus" style="margin-top:8px;font-size:13px;color:#856404;font-weight:600;"></div>
        </div>

        <div class="config-section">
          <label class="config-label">Select Equipment</label>
          <select class="config-select" id="modelSelect" onchange="updateConfigurator()">
            <option value="">Choose a model...</option>
          </select>
        </div>

        <div class="config-section" id="sizeSection" style="display:none;">
          <label class="config-label">Width Size (mm)</label>
          <div class="config-button-group">
            <button class="config-btn" data-size="850" onclick="setSizeOption(this)">850</button>
            <button class="config-btn" data-size="1250" onclick="setSizeOption(this)">1250</button>
            <button class="config-btn" data-size="1650" onclick="setSizeOption(this)">1650</button>
            <button class="config-btn" data-size="2050" onclick="setSizeOption(this)">2050</button>
          </div>
        </div>

        <div class="config-section" id="quantitySection" style="display:none;">
          <label class="config-label">Quantity</label>
          <div class="config-button-group" id="quantityButtons">
            <button class="config-btn" data-qty="1" onclick="setQuantityOption(this)">1</button>
            <button class="config-btn" data-qty="2" onclick="setQuantityOption(this)">2</button>
            <button class="config-btn" data-qty="3" onclick="setQuantityOption(this)">3</button>
            <button class="config-btn" data-qty="4" onclick="setQuantityOption(this)">4</button>
          </div>
          <div class="config-button-group" style="margin-top:8px;">
            <button class="config-btn" id="channeledBtn" onclick="toggleChanneled(this)">Channeled</button>
          </div>
        </div>

        <div class="config-section" id="panelColorSection" style="display:none;">
          <label class="config-label">Panel Color (RAL)</label>
          <div class="color-picker-grid" id="colorPickerGrid"></div>
          <div class="ral-color-input">
            <input type="text" id="ralInput" placeholder="Enter RAL code (e.g. 9005, 1028)">
            <button onclick="applyCustomRalColor()">Apply</button>
          </div>
        </div>

        <div class="config-section" id="customOptionsSection" style="display:none;">
          <label class="config-label">Customizations</label>
          <div id="customOptionsContainer"></div>
        </div>

        <div class="config-section">
          <div class="price-display">
            <div class="price-label">Configured Price</div>
            <div class="price-value">$<span id="configPrice">0</span></div>
          </div>
          <div class="leadtime-display">
            <div class="leadtime-label">Lead Time</div>
            <div class="leadtime-value"><span id="configLeadtime">-</span></div>
          </div>
          <button class="save-config-btn" onclick="saveConfiguration()">üíæ Save Configuration</button>
          <button class="add-to-cart-btn" onclick="addConfigToCart()">üõí Add to Cart</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== ADMIN DASHBOARD ===== -->
<div id="adminView" style="display:none">
  <div class="page">
    <div class="dash-header">
      <div>
        <div class="dash-title">‚öôÔ∏è Admin Dashboard</div>
        <div class="dash-welcome">Welcome back, <strong id="adminWelcomeName"></strong> ‚Äî Equipment Design & Planning Inc.</div>
      </div>
      <button class="btn-primary" onclick="showStorefront()">‚Üê Back to Storefront</button>
    </div>

    <div class="stats-row" id="statsRow"></div>

    <div class="admin-tabs">
      <button class="admin-tab-btn active" onclick="switchAdminTab('products',this)">üì¶ Products</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('3dmodels',this)">üé® 3D Models</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('orders',this)">üìã Orders</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('customers',this)">üë• Customers</button>
    </div>

    <!-- Products Tab -->
    <div id="adminTabProducts">
      <div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
        <button class="btn-primary" onclick="openAddProduct()">+ Add New Product</button>
      </div>

      <!-- Add/Edit Panel -->
      <div class="admin-panel" id="adminPanel">
        <h2 id="adminPanelTitle">‚öôÔ∏è Add New Product Listing</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Product Name *</label>
            <input type="text" id="f_name" placeholder="e.g. Commercial 6-Burner Range">
          </div>
          <div class="form-group">
            <label>Category *</label>
            <select id="f_cat">
              <option>Cooking</option><option>Refrigeration</option><option>Prep</option>
              <option>Ventilation</option><option>Warewashing</option><option>Beverage</option><option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Price ($) *</label>
            <input type="number" id="f_price" placeholder="e.g. 4999">
          </div>
          <div class="form-group">
            <label>SKU / Model Number</label>
            <input type="text" id="f_sku" placeholder="e.g. RNG-6B-36">
          </div>
          <div class="form-group full">
            <label>Description</label>
            <textarea id="f_desc" placeholder="Describe the product, key features, and ideal use cases..."></textarea>
          </div>
          <div class="form-group full">
            <label>Product Images</label>
            <div class="img-upload-area" onclick="document.getElementById('imgInput').click()">
              <div class="upload-icon">üì∑</div>
              <p>Click to upload product images (JPG, PNG, WEBP)</p>
              <p style="font-size:12px;margin-top:4px;">First image will be the main product photo</p>
              <input type="file" id="imgInput" multiple accept="image/*" onchange="handleImages(this)">
            </div>
          </div>
          <div class="img-preview-strip" id="imgPreviews"></div>
          <div class="spec-builder">
            <label>Specification Sheet</label>
            <div id="specRows">
              <div class="spec-row-input">
                <input type="text" placeholder="Spec name (e.g. Dimensions)" class="spec-key">
                <input type="text" placeholder='Value (e.g. 36" W x 28" D)' class="spec-val">
                <button class="remove-spec" onclick="this.parentElement.remove()">‚úï</button>
              </div>
              <div class="spec-row-input">
                <input type="text" placeholder="Spec name (e.g. Material)" class="spec-key">
                <input type="text" placeholder="Value (e.g. 304 Stainless Steel)" class="spec-val">
                <button class="remove-spec" onclick="this.parentElement.remove()">‚úï</button>
              </div>
            </div>
            <button class="add-spec-btn" onclick="addSpec()">+ Add Specification</button>
          </div>
          <div class="form-actions">
            <button class="btn-cancel" onclick="closeAdminPanel()">Cancel</button>
            <button class="btn-save" onclick="saveProduct()">üíæ Save & Publish Listing</button>
          </div>
        </div>
      </div>

      <!-- Products list (admin view) -->
      <div class="product-grid" id="adminProductGrid" style="margin-top:24px;"></div>
    </div>

    <!-- Orders Tab -->
    <div id="adminTabOrders" style="display:none">
      <div class="table-wrap">
        <div class="table-head orders-cols">
          <span>Order #</span><span>Customer / Items</span><span>Date</span><span>Total</span><span>Status</span><span>Actions</span>
        </div>
        <div id="ordersTableBody"></div>
      </div>
    </div>

    <!-- Customers Tab -->
    <div id="adminTabCustomers" style="display:none">
      <div class="table-wrap">
        <div class="table-head customers-cols">
          <span>#</span><span>Name / Email</span><span>Account ID</span><span>Orders</span><span>Status</span>
        </div>
        <div id="customersTableBody"></div>
      </div>
    </div>

    <!-- 3D Models Tab -->
    <div id="adminTab3dmodels" style="display:none">
      <div style="background:#f0f4ff;border-left:4px solid var(--navy);padding:16px;margin-bottom:24px;border-radius:8px;">
        <div style="font-weight:600;font-size:15px;margin-bottom:8px;color:var(--navy);">üì¶ 3D Model Management</div>
        <div style="font-size:13px;color:#666;line-height:1.6;">
          Upload GLB/GLTF 3D models for your equipment products. Once uploaded, these models will be available 
          in the <strong>Equipment Configurator</strong> dropdown for users to view and configure. 
          Models are stored in browser localStorage and persist across sessions.
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-bottom:16px;">
        <button class="btn-primary" onclick="openAdd3DModel()">+ Add 3D Model</button>
      </div>

      <div class="admin-panel" id="adminModel3DPanel" style="display:none">
        <h2>üé® Add/Edit 3D Model with Variants</h2>
        
        <h3 style="margin-top:20px;margin-bottom:12px;font-size:16px;color:var(--navy);">Base Model Details</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Model Name *</label>
            <input type="text" id="model3dName" placeholder="e.g., Display Case 1200L">
          </div>
          <div class="form-group">
            <label>Equipment Category</label>
            <select id="model3dCategory">
              <option value="">Select category...</option>
              <option value="Display Cases">Display Cases</option>
              <option value="Grab & Go">Grab & Go</option>
              <option value="Cooking">Cooking</option>
              <option value="Refrigeration">Refrigeration</option>
            </select>
            <small style="color:var(--muted);margin-top:4px;display:block;">Optional - defaults to "Uncategorized"</small>
          </div>
          <div class="form-group">
            <label>Base Price ($)</label>
            <input type="number" id="model3dPrice" placeholder="e.g., 4200">
            <small style="color:var(--muted);margin-top:4px;display:block;">Optional - defaults to $0</small>
          </div>
          <div class="form-group">
            <label>Lead Time (days)</label>
            <input type="number" id="model3dLeadtime" placeholder="e.g., 14">
            <small style="color:var(--muted);margin-top:4px;display:block;">Optional - defaults to 14 days</small>
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label>Base Model File (glTF/GLB) *</label>
            <input type="file" id="model3dFile" accept=".glb,.gltf">
            <small style="color:var(--muted);margin-top:4px;display:block;">Required - Main equipment 3D model file</small>
          </div>
        </div>

        <h3 style="margin-top:24px;margin-bottom:12px;font-size:16px;color:var(--navy);">Customization Variants (Optional)</h3>
        <div id="variantsList" style="margin-bottom:16px;"></div>
        <button class="btn-outline" style="margin-bottom:16px;" onclick="addVariantGroup()">+ Add Customization Option</button>

        <div style="display:flex;gap:8px;margin-top:24px;">
          <button class="btn-primary" onclick="saveModel3DWithVariants()">Save Model & Variants</button>
          <button class="btn-outline" onclick="closeAdd3DModel()">Cancel</button>
        </div>
      </div>

      <div style="margin-top:32px;">
        <h3 style="font-size:18px;margin-bottom:16px;color:var(--navy);">Available 3D Models</h3>
        <div id="model3dList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== CUSTOMER PORTAL ===== -->
<div id="customerPortalView" style="display:none">
  <div class="page">
    <div class="dash-header">
      <div>
        <div class="dash-title">üì¶ My Account</div>
        <div class="dash-welcome" id="portalWelcome"></div>
      </div>
      <button class="btn-primary" onclick="showStorefront()">‚Üê Continue Shopping</button>
    </div>

    <!-- Order Status -->
    <div class="portal-section">
      <div class="portal-section-title">Order History & Tracking</div>
      <div id="customerOrders"></div>
    </div>

    <!-- Warranty -->
    <div class="portal-section">
      <div class="portal-section-title">Warranty Status</div>
      <div id="customerWarranty"></div>
    </div>
  </div>
</div>

</div><!-- end #mainSite -->

<!-- Product Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modalTitle">Product Details</span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div>
          <div class="modal-main-img" id="modalMainImg"></div>
          <div class="modal-thumbs" id="modalThumbs"></div>
        </div>
        <div class="modal-info">
          <div class="modal-cat" id="modalCat"></div>
          <h2 id="modalName"></h2>
          <div class="modal-price" id="modalPrice"></div>
          <p class="modal-desc" id="modalDesc"></p>
          <div class="modal-specs" id="modalSpecs"></div>
          <div class="modal-actions">
            <button class="btn-primary" id="modalCartBtn">Add to Cart</button>
            <button class="spec-sheet-btn" onclick="downloadSpec()">üìÑ Spec Sheet</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cart -->
<div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
<div class="cart-drawer" id="cartDrawer">
  <div class="cart-head">
    <h3>üõí Your Cart</h3>
    <button class="cart-close" onclick="toggleCart()">‚úï</button>
  </div>
  <div class="cart-items" id="cartItems"><div class="cart-empty">Your cart is empty.</div></div>
  <div class="cart-foot">
    <div class="cart-total"><span>Total</span><span id="cartTotal">$0.00</span></div>
    <button class="checkout-btn">Request a Quote / Checkout</button>
  </div>
</div>

<!-- Confirm Delete -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3>Delete Product?</h3>
    <p>This will permanently remove the product listing. This action cannot be undone.</p>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-delete" onclick="confirmDelete()">üóë Delete</button>
    </div>
  </div>
</div>

<footer>
  <div class="footer-inner">
    <div class="footer-grid">
      <div class="footer-brand">
        <div class="logo-main">Equipment Design & Planning</div>
        <div class="logo-sub">Inc.</div>
        <p>Your trusted source for commercial-grade restaurant equipment. We design, supply, and support foodservice operations of every scale.</p>
      </div>
      <div class="footer-col">
        <h4>Shop</h4>
        <a href="#">All Equipment</a><a href="#">Cooking</a><a href="#">Refrigeration</a><a href="#">Prep & Storage</a><a href="#">Ventilation</a>
      </div>
      <div class="footer-col">
        <h4>Company</h4>
        <a href="#">About Us</a><a href="#">Design Services</a><a href="#">Installation</a><a href="#">Support</a><a href="#">Contact</a>
      </div>
      <div class="footer-col">
        <h4>Info</h4>
        <a href="#">Shipping Policy</a><a href="#">Returns</a><a href="#">Warranty</a><a href="#">Financing</a><a href="#">Privacy Policy</a>
      </div>
    </div>
    <div class="footer-bottom">
      <span>¬© 2024 Equipment Design & Planning Inc. All rights reserved.</span>
      <span>üìû (800) 555-0192 &nbsp; ‚úâÔ∏è sales@edpinc.com</span>
    </div>
  </div>
</footer>

<div class="toast" id="toast"></div>

<script>
// ======= AUTH DATA =======
const ADMIN_CREDS = { username: 'admin', password: 'edp2024', name: 'Michael Torres' };
const CUSTOMERS = [
  { id: 'CUST-001', name: "John Meadows", email: "john@greens.com", orderKey: "EDP-10042", company: "Green's Restaurant" },
  { id: 'CUST-002', name: "Sarah Chen", email: "sarah@citygrill.com", orderKey: "EDP-10039", company: "City Grill & Bar" },
];

// ======= ORDERS DATA =======
const ORDERS = [
  { id:'EDP-10042', customerId:'CUST-001', customer:'John Meadows', company:"Green's Restaurant", items:['Commercial 6-Burner Gas Range','Reach-In Refrigerator 49 cu.ft.'], date:'Jan 28, 2025', total:7498, status:'shipped', tracking:'1Z999AA10123456784', trackingSteps: [{label:'Order Placed',date:'Jan 28, 2025',done:true},{label:'Payment Confirmed',date:'Jan 29, 2025',done:true},{label:'Shipped from Warehouse',date:'Feb 1, 2025',done:true},{label:'Out for Delivery',date:'Feb 5, 2025',done:false,active:true},{label:'Delivered',date:'Est. Feb 6, 2025',done:false}] },
  { id:'EDP-10041', customerId:'CUST-001', customer:'John Meadows', company:"Green's Restaurant", items:['Wall Mounted Exhaust Hood 96"'], date:'Dec 15, 2024', total:2650, status:'delivered', tracking:'1Z999AA10123411111', trackingSteps: [{label:'Order Placed',date:'Dec 15, 2024',done:true},{label:'Payment Confirmed',date:'Dec 15, 2024',done:true},{label:'Shipped from Warehouse',date:'Dec 18, 2024',done:true},{label:'Out for Delivery',date:'Dec 22, 2024',done:true},{label:'Delivered',date:'Dec 23, 2024',done:true}] },
  { id:'EDP-10039', customerId:'CUST-002', customer:'Sarah Chen', company:'City Grill & Bar', items:["Undercounter Dishwasher","Commercial Prep Table 60\""], date:'Jan 15, 2025', total:5979, status:'processing', tracking:null, trackingSteps: [{label:'Order Placed',date:'Jan 15, 2025',done:true},{label:'Payment Confirmed',date:'Jan 15, 2025',done:true},{label:'Shipped from Warehouse',date:'Pending',done:false,active:true},{label:'Out for Delivery',date:'‚Äî',done:false},{label:'Delivered',date:'‚Äî',done:false}] },
  { id:'EDP-10035', customerId:'CUST-002', customer:'Sarah Chen', company:'City Grill & Bar', items:['Commercial Coffee Brewer 3-Warmer'], date:'Nov 3, 2024', total:699, status:'delivered', tracking:'1Z999AA10199988877', trackingSteps: [{label:'Order Placed',date:'Nov 3, 2024',done:true},{label:'Payment Confirmed',date:'Nov 3, 2024',done:true},{label:'Shipped from Warehouse',date:'Nov 6, 2024',done:true},{label:'Out for Delivery',date:'Nov 9, 2024',done:true},{label:'Delivered',date:'Nov 10, 2024',done:true}] },
];

const WARRANTIES = {
  'CUST-001': [
    { product:"Commercial 6-Burner Gas Range", orderId:'EDP-10042', serial:'RNG-6B-36-2025-0128', startDate:'Jan 28, 2025', endDate:'Jan 28, 2027', durationMonths:24, elapsed:1, status:'active' },
    { product:'Wall Mounted Exhaust Hood 96"', orderId:'EDP-10041', serial:'VNT-WH-96-2024-1223', startDate:'Dec 23, 2024', endDate:'Dec 23, 2025', durationMonths:12, elapsed:2, status:'active' },
    { product:'Reach-In Refrigerator 49 cu.ft.', orderId:'EDP-10042', serial:'REF-49-2025-0128', startDate:'Jan 28, 2025', endDate:'Jan 28, 2028', durationMonths:36, elapsed:1, status:'active' },
  ],
  'CUST-002': [
    { product:'Undercounter Dishwasher', orderId:'EDP-10039', serial:'DW-UC-2025-0115', startDate:'Jan 15, 2025', endDate:'Jan 15, 2027', durationMonths:24, elapsed:0, status:'pending' },
    { product:'Commercial Coffee Brewer', orderId:'EDP-10035', serial:'COF-3W-2024-1110', startDate:'Nov 10, 2024', endDate:'Nov 10, 2025', durationMonths:12, elapsed:3, status:'active' },
  ]
};

// ======= PRODUCTS DATA =======
let products = [
  { id:1, name:"Commercial 6-Burner Gas Range", category:"Cooking", price:4299, sku:"RNG-6B-36", badge:"Best Seller", desc:'Heavy-duty 36" commercial range with six 30,000 BTU open burners, standard oven, and 304 stainless steel construction. Built for high-volume kitchens.', images:[], icon:"üî•", specs:[{k:"Dimensions",v:'36" W x 28" D x 35" H'},{k:"BTU Output",v:"180,000 BTU/hr total"},{k:"Burners",v:"6 √ó 30,000 BTU open"},{k:"Material",v:"304 Stainless Steel"},{k:"Gas Type",v:"Nat. Gas / LP convertible"},{k:"Weight",v:"320 lbs"},{k:"Certifications",v:"NSF, CSA, ETL"}] },
  { id:2, name:"Reach-In Refrigerator 49 cu.ft.", category:"Refrigeration", price:3199, sku:"REF-49-2DR", desc:'Two-section reach-in refrigerator with stainless steel interior and exterior, digital temperature control, and self-closing doors.', images:[], icon:"‚ùÑÔ∏è", specs:[{k:"Capacity",v:"49 cu. ft."},{k:"Dimensions",v:'52" W x 32" D x 83" H'},{k:"Temp Range",v:"33¬∞F ‚Äì 41¬∞F"},{k:"Doors",v:"2 Full-Height Solid"},{k:"Shelves",v:"6 Adjustable Wire"},{k:"Refrigerant",v:"R-290"},{k:"Certifications",v:"NSF, Energy Star"}] },
  { id:3, name:'Commercial Prep Table 60"', category:"Prep", price:879, sku:"PT-60-SS", badge:"New", desc:'60" stainless steel work table with adjustable undershelf. 16-gauge top, ideal for food preparation in any commercial kitchen.', images:[], icon:"üî™", specs:[{k:"Dimensions",v:'60" W x 30" D x 34" H'},{k:"Top Gauge",v:"16-Gauge 304 SS"},{k:"Undershelf",v:"18-Gauge, Adjustable"},{k:"Legs",v:"Adjustable Bullet Feet"},{k:"Certifications",v:"NSF 2"}] },
  { id:4, name:'Wall Mounted Exhaust Hood 96"', category:"Ventilation", price:2650, sku:"VNT-WH-96", desc:'Heavy-duty 96" wall-mounted exhaust hood with built-in baffle filters, grease troughs, and integrated LED lighting.', images:[], icon:"üí®", specs:[{k:"Width",v:'96" (8 ft)'},{k:"Projection",v:'48"'},{k:"Height",v:'24"'},{k:"Filters",v:"SS Baffle Filters"},{k:"Lighting",v:"2 √ó LED Fixtures"},{k:"Certifications",v:"NFPA 96, NSF 2, UL 710"}] },
  { id:5, name:"Undercounter Dishwasher", category:"Warewashing", price:5100, sku:"DW-UC-PRO", desc:"High-temp undercounter dishwasher with built-in booster heater, 30 racks/hour capacity, and auto-fill/drain.", images:[], icon:"ü´ß", specs:[{k:"Capacity",v:"30 racks/hour"},{k:"Wash Temp",v:"150¬∞F"},{k:"Final Rinse",v:"180¬∞F"},{k:"Dimensions",v:'24" W x 26" D x 33" H'},{k:"Booster",v:"Built-In 5 kW"},{k:"Certifications",v:"NSF 3, ENERGY STAR"}] },
  { id:6, name:"Commercial Coffee Brewer 3-Warmer", category:"Beverage", price:699, sku:"COF-3W-64", desc:"64 oz per cycle commercial coffee brewer with three independent warming stations, digital controls, and auto-clean cycle.", images:[], icon:"‚òï", specs:[{k:"Brew Capacity",v:"3 √ó 64 oz/cycle"},{k:"Warmers",v:"3 √ó Independent"},{k:"Voltage",v:"120V / 15A"},{k:"Dimensions",v:'22" W x 18" D x 20" H'},{k:"Certifications",v:"NSF, ETL, UL"}] }
];

// ======= STATE =======
let cart = [];
let currentFilter = 'All';
let currentSort = 'default';
let uploadedImages = [];
let currentProduct = null;
let currentUser = null; // { role: 'admin'|'customer'|'guest', ...data }
let editingProductId = null;
let deleteProductId = null;

// ======= LOGIN =======
function switchLoginTab(tab) {
  document.getElementById('loginAdminPane').style.display = tab==='admin' ? 'block' : 'none';
  document.getElementById('loginCustomerPane').style.display = tab==='customer' ? 'block' : 'none';
  document.getElementById('tabAdmin').classList.toggle('active', tab==='admin');
  document.getElementById('tabCustomer').classList.toggle('active', tab==='customer');
}

function doLogin(role) {
  if (role === 'admin') {
    const u = document.getElementById('adminUser').value.trim();
    const p = document.getElementById('adminPass').value;
    if (u === ADMIN_CREDS.username && p === ADMIN_CREDS.password) {
      currentUser = { role:'admin', name: ADMIN_CREDS.name, username: u };
      enterSite();
    } else {
      document.getElementById('adminError').classList.add('show');
    }
  } else {
    const email = document.getElementById('custEmail').value.trim().toLowerCase();
    const orderKey = document.getElementById('custOrder').value.trim().toUpperCase();
    const cust = CUSTOMERS.find(c => c.email.toLowerCase() === email && c.orderKey.toUpperCase() === orderKey);
    if (cust) {
      currentUser = { role:'customer', ...cust };
      enterSite();
    } else {
      document.getElementById('custError').classList.add('show');
    }
  }
}

function guestBrowse() {
  currentUser = { role:'guest', name:'Guest' };
  enterSite();
}

function enterSite() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainSite').style.display = 'block';
  setupUIForRole();
  renderProducts(getFiltered());
  updateCart();
}

// ======= 3D MODEL MANAGEMENT =======
let model3DData = {
  'display-case-1': { file: '', fileName: 'display-case-1.glb' },
  'grab-go-1': { file: '', fileName: 'grab-go-1.glb' }
};

// Restore model3DData from localStorage
if (localStorage.getItem('model3DData')) {
  try {
    const savedData = JSON.parse(localStorage.getItem('model3DData'));
    model3DData = { ...model3DData, ...savedData };
    console.log('‚úì Restored', Object.keys(savedData).length, '3D model files from storage');
  } catch (e) {
    console.warn('Could not restore model3DData from localStorage');
  }
}

let currentVariantGroup = 0;
let variantFiles = {}; // Track variant files being uploaded

// Restore variantFiles from localStorage
if (localStorage.getItem('variantFiles')) {
  try {
    variantFiles = JSON.parse(localStorage.getItem('variantFiles'));
    console.log('‚úì Restored', Object.keys(variantFiles).length, 'variant files from storage');
  } catch (e) {
    console.warn('Could not restore variantFiles from localStorage');
  }
}

function openAdd3DModel() {
  document.getElementById('adminModel3DPanel').style.display = 'block';
  document.getElementById('model3dName').value = '';
  document.getElementById('model3dCategory').value = '';
  document.getElementById('model3dPrice').value = '';
  document.getElementById('model3dLeadtime').value = '';
  document.getElementById('model3dFile').value = '';
  document.getElementById('variantsList').innerHTML = '';
  currentVariantGroup = 0;
  variantFiles = {};
}

function closeAdd3DModel() {
  document.getElementById('adminModel3DPanel').style.display = 'none';
}

function addVariantGroup() {
  const html = `
    <div class="variant-group" id="variantGroup${currentVariantGroup}" style="border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;background:var(--silver-light);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <input type="text" placeholder="e.g., Glass Type, Door Configuration" style="flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-weight:600;" class="variantGroupName" value="">
        <button style="margin-left:8px;padding:6px 12px;background:var(--red);color:white;border:none;border-radius:6px;cursor:pointer;" onclick="removeVariantGroup(${currentVariantGroup})">Remove</button>
      </div>
      <div id="variantOptions${currentVariantGroup}" style="margin-top:12px;"></div>
      <button style="margin-top:8px;padding:6px 12px;background:var(--navy);color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;" onclick="addVariantOption(${currentVariantGroup})">+ Add Option</button>
    </div>
  `;
  document.getElementById('variantsList').innerHTML += html;
  addVariantOption(currentVariantGroup);
  currentVariantGroup++;
}

function addVariantOption(groupIdx) {
  const optionIdx = Date.now();
  const html = `
    <div class="variant-option" id="variantOption${optionIdx}" style="background:white;padding:12px;border-radius:6px;margin-bottom:8px;border:1px solid var(--border);">
      <div style="display:flex;gap:8px;align-items:end;">
        <div style="flex:1;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">Option Name</label>
          <input type="text" placeholder="e.g., High Glass" class="variantOptionName" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;">
        </div>
        <div style="flex:1;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">Price Adjustment ($)</label>
          <input type="number" placeholder="0" class="variantOptionPrice" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;">
        </div>
        <div style="flex:1;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">3D File (glTF/GLB)</label>
          <input type="file" accept=".glb,.gltf" class="variantOptionFile" style="padding:4px;font-size:11px;">
        </div>
        <button style="padding:6px 12px;background:var(--red);color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;white-space:nowrap;" onclick="document.getElementById('variantOption${optionIdx}').remove()">Delete</button>
      </div>
    </div>
  `;
  document.getElementById(`variantOptions${groupIdx}`).innerHTML += html;
}

function removeVariantGroup(groupIdx) {
  document.getElementById(`variantGroup${groupIdx}`).remove();
}

function saveModel3DWithVariants() {
  const name = document.getElementById('model3dName').value.trim();
  const category = document.getElementById('model3dCategory').value || 'Uncategorized';
  const price = parseFloat(document.getElementById('model3dPrice').value) || 0;
  const leadtime = parseInt(document.getElementById('model3dLeadtime').value) || 14;
  const baseFile = document.getElementById('model3dFile').files[0];
  
  // Only require name and file - everything else has defaults
  if (!name) {
    alert('Please enter a model name');
    return;
  }
  
  if (!baseFile) {
    alert('Please select a 3D model file (.glb or .gltf)');
    return;
  }
  
  if (!baseFile.name.endsWith('.glb') && !baseFile.name.endsWith('.gltf')) {
    alert('Base model must be a valid glTF (.glb or .gltf) file');
    return;
  }

  // Read base file
  const baseReader = new FileReader();
  baseReader.onload = (baseEvent) => {
    const modelId = 'model-' + Date.now();
    
    // Collect customization options
    const customizations = [];
    const variantGroups = document.querySelectorAll('.variant-group');
    
    variantGroups.forEach((group, groupIdx) => {
      const groupName = group.querySelector('.variantGroupName').value || `Option Group ${groupIdx + 1}`;
      const options = [];
      
      const optionDivs = group.querySelectorAll('.variant-option');
      optionDivs.forEach((optDiv) => {
        const optName = optDiv.querySelector('.variantOptionName').value;
        const optPrice = parseFloat(optDiv.querySelector('.variantOptionPrice').value) || 0;
        const optFile = optDiv.querySelector('.variantOptionFile').files[0];
        
        if (optName && optFile) {
          // Read variant file
          const variantReader = new FileReader();
          variantReader.onload = (variantEvent) => {
            const variantKey = `${modelId}_${groupIdx}_${optName}`;
            variantFiles[variantKey] = {
              file: variantEvent.target.result,
              fileName: optFile.name,
              optionName: optName,
              groupName: groupName
            };
          };
          variantReader.readAsDataURL(optFile);
          
          options.push({
            id: optName.toLowerCase().replace(/\s+/g, '-'),
            name: optName,
            priceAdj: optPrice,
            variantKey: `${modelId}_${groupIdx}_${optName}`
          });
        }
      });
      
      if (options.length > 0) {
        customizations.push({
          id: groupName.toLowerCase().replace(/\s+/g, '-'),
          name: groupName,
          options: options
        });
      }
    });

    // Create model structure
    const newModel = {
      id: modelId,
      name: name,
      category: category,
      basePrice: price,
      leadTimeDays: leadtime,
      widths: [850, 1250, 1650, 2050],
      defaultWidth: 1250,
      depth: 720,
      height: 1200,
      panelColors: ['9005', '9016', '1028', '5015'],
      customizations: customizations,
      baseModel: baseEvent.target.result,
      baseFileName: baseFile.name,
      uploadDate: new Date().toLocaleDateString(),
      useGLTF: true  // Flag to load actual 3D models
    };
    
    CONFIGURATOR_MODELS.push(newModel);
    model3DData[modelId] = { file: baseEvent.target.result, fileName: baseFile.name };
    
    // Save to localStorage with error handling
    try {
      const modelsJson = JSON.stringify(CONFIGURATOR_MODELS);
      const dataJson = JSON.stringify(model3DData);
      const variantsJson = JSON.stringify(variantFiles);
      
      console.log('üíæ Saving to localStorage:');
      console.log('  Models JSON size:', (modelsJson.length / 1024 / 1024).toFixed(2), 'MB');
      console.log('  Model3DData size:', (dataJson.length / 1024 / 1024).toFixed(2), 'MB');
      console.log('  Variants size:', (variantsJson.length / 1024 / 1024).toFixed(2), 'MB');
      
      localStorage.setItem('configuratorModels', modelsJson);
      localStorage.setItem('model3DData', dataJson);
      localStorage.setItem('variantFiles', variantsJson);
      
      // Verify it was saved by reading it back
      const verify = localStorage.getItem('configuratorModels');
      if (verify && verify.length > 100) {
        console.log('‚úÖ Successfully saved to localStorage');
        showToast(`‚úÖ 3D Model "${name}" saved successfully!`);
      } else {
        console.error('‚ö†Ô∏è localStorage save appeared to fail or was truncated');
        showToast(`‚ö†Ô∏è Model saved but may not persist. File may be too large for browser storage.`);
      }
    } catch (error) {
      console.error('‚ùå Failed to save to localStorage:', error);
      if (error.name === 'QuotaExceededError') {
        showToast(`‚ùå Model too large for browser storage (${(baseEvent.target.result.length / 1024 / 1024).toFixed(2)} MB). Try a smaller file.`);
        alert(`Storage Error: The 3D model file is too large to save in browser storage.\n\nFile size: ${(baseEvent.target.result.length / 1024 / 1024).toFixed(2)} MB\nBrowser limit: ~5-10 MB\n\nPlease use a smaller/optimized 3D model file.`);
      } else {
        showToast(`‚ùå Failed to save model: ${error.message}`);
      }
    }
    
    closeAdd3DModel();
    renderModel3DList();
  };
  baseReader.readAsDataURL(baseFile);
}

function renderModel3DList() {
  const listDiv = document.getElementById('model3dList');
  if (!CONFIGURATOR_MODELS.length) {
    listDiv.innerHTML = '<p style="color:var(--muted);text-align:center;padding:32px;">No 3D models uploaded yet.</p>';
    return;
  }
  
  listDiv.innerHTML = CONFIGURATOR_MODELS.map(m => `
    <div style="border:2px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;background:white;">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
        <div style="flex:1;">
          <div style="font-weight:700;font-size:16px;color:var(--navy);margin-bottom:4px;">${m.name}</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:8px;">Category: ${m.category} | Price: $${m.basePrice.toLocaleString()} | Lead Time: ${m.leadTimeDays} days</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">Base Model: ${m.baseFileName || 'N/A'}</div>
          ${m.customizations && m.customizations.length > 0 ? `
            <div style="font-size:12px;color:var(--navy);font-weight:600;margin-top:8px;">Customization Options:</div>
            <div style="font-size:12px;margin-left:12px;color:var(--muted);">
              ${m.customizations.map(c => `
                <div style="margin-top:4px;">
                  <strong>${c.name}:</strong> ${c.options.map(o => o.name).join(', ')}
                </div>
              `).join('')}
            </div>
          ` : '<div style="font-size:12px;color:var(--muted);margin-top:8px;"><em>No customization variants</em></div>'}
        </div>
        <button class="admin-del-btn" onclick="deleteModel3D('${m.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

function deleteModel3D(modelId) {
  if (!confirm('Are you sure you want to delete this 3D model?')) return;
  
  const idx = CONFIGURATOR_MODELS.findIndex(m => m.id === modelId);
  if (idx > -1) {
    CONFIGURATOR_MODELS.splice(idx, 1);
    delete model3DData[modelId];
    
    localStorage.setItem('configuratorModels', JSON.stringify(CONFIGURATOR_MODELS));
    localStorage.setItem('model3DData', JSON.stringify(model3DData));
    
    showToast('üóë 3D Model deleted');
    renderModel3DList();
  }
}

function setupUIForRole() {
  const r = currentUser.role;

  // User pill
  const wrap = document.getElementById('userPillWrap');
  if (r === 'guest') {
    wrap.innerHTML = `<button onclick="document.getElementById('loginScreen').classList.remove('hidden');" style="background:none;border:1.5px solid var(--border);padding:6px 16px;border-radius:20px;font-size:13px;font-weight:600;color:var(--navy);cursor:pointer;">Sign In</button>`;
  } else {
    const initials = currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase();
    wrap.innerHTML = `
      <div class="user-pill" onclick="doLogout()" title="Click to sign out">
        <div class="user-avatar ${r}">${initials}</div>
        <div>
          <div class="user-name">${currentUser.name}</div>
        </div>
        <span class="user-role-badge ${r}">${r === 'admin' ? 'Admin' : 'Customer'}</span>
      </div>`;
  }

  // Dashboard/portal buttons
  document.getElementById('adminHeaderBtn').style.display = r==='admin' ? 'flex' : 'none';
  document.getElementById('portalHeaderBtn').style.display = r==='customer' ? 'flex' : 'none';
  document.getElementById('signInBtn').style.display = r==='guest' ? 'flex' : 'none';

  // Hero buttons
  document.getElementById('heroAdminBtn').style.display = r==='admin' ? 'inline-flex' : 'none';
  document.getElementById('heroPortalBtn').style.display = r==='customer' ? 'inline-flex' : 'none';

  // Nav portal link
  const navLink = document.getElementById('navPortalLink');
  if (r==='admin') { navLink.style.display='block'; navLink.textContent='‚öôÔ∏è Dashboard'; navLink.onclick=showAdminDash; }
  else if (r==='customer') { navLink.style.display='block'; navLink.textContent='üì¶ My Account'; navLink.onclick=showCustomerPortal; }
  else { navLink.style.display='none'; }

  if (r==='admin') { document.getElementById('adminWelcomeName').textContent = currentUser.name; }
  if (r==='customer') { document.getElementById('portalWelcome').textContent = `Welcome, ${currentUser.name} ‚Äî ${currentUser.company}`; }
}

function doLogout() {
  if (!confirm('Sign out of your account?')) return;
  currentUser = null;
  document.getElementById('mainSite').style.display = 'none';
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
  document.getElementById('custEmail').value = '';
  document.getElementById('custOrder').value = '';
  document.getElementById('adminError').classList.remove('show');
  document.getElementById('custError').classList.remove('show');
  showStorefront();
}

// ======= VIEW ROUTING =======
function showStorefront() {
  document.getElementById('storefrontView').style.display = 'block';
  document.getElementById('adminView').style.display = 'none';
  document.getElementById('customerPortalView').style.display = 'none';
  document.getElementById('configuratorView').style.display = 'none';
}
function showAdminDash() {
  document.getElementById('storefrontView').style.display = 'none';
  document.getElementById('adminView').style.display = 'block';
  document.getElementById('customerPortalView').style.display = 'none';
  renderAdminStats();
  renderAdminProducts();
  renderOrdersTable();
  renderCustomersTable();
  window.scrollTo(0,0);
}
function showCustomerPortal() {
  document.getElementById('storefrontView').style.display = 'none';
  document.getElementById('adminView').style.display = 'none';
  document.getElementById('customerPortalView').style.display = 'block';
  renderCustomerPortal();
  window.scrollTo(0,0);
}

// ======= ADMIN STATS =======
function renderAdminStats() {
  const totalRevenue = ORDERS.reduce((s,o) => s+o.total,0);
  document.getElementById('statsRow').innerHTML = `
    <div class="stat-card"><div class="stat-icon">üì¶</div><div class="stat-val">${products.length}</div><div class="stat-label">Products Listed</div></div>
    <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-val">${ORDERS.length}</div><div class="stat-label">Total Orders</div></div>
    <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-val">${CUSTOMERS.length}</div><div class="stat-label">Customers</div></div>
    <div class="stat-card"><div class="stat-icon">üíµ</div><div class="stat-val">$${(totalRevenue/1000).toFixed(1)}k</div><div class="stat-label">Total Revenue</div></div>
    <div class="stat-card"><div class="stat-icon">üöö</div><div class="stat-val">${ORDERS.filter(o=>o.status==='shipped').length}</div><div class="stat-label">In Transit</div></div>
  `;
}

// ======= ADMIN TABS =======
function switchAdminTab(tab, btn) {
  document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  document.getElementById('adminTabProducts').style.display = tab==='products' ? 'block' : 'none';
  document.getElementById('adminTab3dmodels').style.display = tab==='3dmodels' ? 'block' : 'none';
  document.getElementById('adminTabOrders').style.display = tab==='orders' ? 'block' : 'none';
  document.getElementById('adminTabCustomers').style.display = tab==='customers' ? 'block' : 'none';
  if (tab === '3dmodels') {
    renderModel3DList();
  }
}

// ======= ADMIN PRODUCTS =======
function renderAdminProducts() {
  const grid = document.getElementById('adminProductGrid');
  grid.innerHTML = products.map(p => `
    <div class="product-card">
      <div class="product-img">
        ${p.images.length ? `<img src="${p.images[0]}" alt="${p.name}">` : `<span class="placeholder-icon">${p.icon}</span>`}
        ${p.badge ? `<span class="product-badge">${p.badge}</span>` : ''}
        <div class="admin-product-controls">
          <button class="admin-edit-btn" onclick="event.stopPropagation();openEditProduct(${p.id})">‚úèÔ∏è Edit</button>
          <button class="admin-del-btn" onclick="event.stopPropagation();promptDelete(${p.id})">üóë</button>
        </div>
      </div>
      <div class="product-info">
        <div class="product-category">${p.category}</div>
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.desc}</div>
        <div class="product-footer">
          <div class="product-price">$${p.price.toLocaleString()}</div>
          <span style="font-size:12px;color:var(--muted);">SKU: ${p.sku||'‚Äî'}</span>
        </div>
      </div>
    </div>`).join('');
}

function openAddProduct() {
  editingProductId = null;
  document.getElementById('adminPanelTitle').textContent = '‚öôÔ∏è Add New Product Listing';
  ['f_name','f_price','f_sku','f_desc'].forEach(id => document.getElementById(id).value='');
  document.getElementById('f_cat').value='Cooking';
  uploadedImages = [];
  renderPreviews();
  document.getElementById('specRows').innerHTML = `
    <div class="spec-row-input"><input type="text" placeholder="Spec name" class="spec-key"><input type="text" placeholder="Value" class="spec-val"><button class="remove-spec" onclick="this.parentElement.remove()">‚úï</button></div>
    <div class="spec-row-input"><input type="text" placeholder="Spec name" class="spec-key"><input type="text" placeholder="Value" class="spec-val"><button class="remove-spec" onclick="this.parentElement.remove()">‚úï</button></div>`;
  document.getElementById('adminPanel').classList.add('open');
  document.getElementById('adminPanel').scrollIntoView({behavior:'smooth', block:'start'});
}

function openEditProduct(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  editingProductId = id;
  document.getElementById('adminPanelTitle').textContent = '‚úèÔ∏è Edit Product Listing';
  document.getElementById('f_name').value = p.name;
  document.getElementById('f_price').value = p.price;
  document.getElementById('f_sku').value = p.sku||'';
  document.getElementById('f_desc').value = p.desc;
  document.getElementById('f_cat').value = p.category;
  uploadedImages = [...p.images];
  renderPreviews();
  document.getElementById('specRows').innerHTML = p.specs.map(s => `
    <div class="spec-row-input"><input type="text" class="spec-key" value="${s.k}"><input type="text" class="spec-val" value="${s.v}"><button class="remove-spec" onclick="this.parentElement.remove()">‚úï</button></div>`).join('');
  document.getElementById('adminPanel').classList.add('open');
  document.getElementById('adminPanel').scrollIntoView({behavior:'smooth', block:'start'});
}

function closeAdminPanel() {
  document.getElementById('adminPanel').classList.remove('open');
  editingProductId = null;
}

function saveProduct() {
  const name = document.getElementById('f_name').value.trim();
  const price = parseFloat(document.getElementById('f_price').value);
  if (!name || isNaN(price)) { showToast('‚ö†Ô∏è Please enter a product name and price'); return; }
  const specs = [...document.querySelectorAll('#specRows .spec-row-input')].map(r => ({k:r.querySelector('.spec-key').value.trim(), v:r.querySelector('.spec-val').value.trim()})).filter(s => s.k && s.v);
  const icons = {Cooking:'üî•',Refrigeration:'‚ùÑÔ∏è',Prep:'üî™',Ventilation:'üí®',Warewashing:'ü´ß',Beverage:'‚òï'};
  const cat = document.getElementById('f_cat').value;
  if (editingProductId) {
    const idx = products.findIndex(p => p.id === editingProductId);
    products[idx] = { ...products[idx], name, category:cat, price, sku:document.getElementById('f_sku').value.trim(), desc:document.getElementById('f_desc').value.trim()||'Commercial-grade restaurant equipment.', images:[...uploadedImages], icon:icons[cat]||'üì¶', specs };
    showToast('‚úÖ Product updated successfully!');
  } else {
    products.unshift({ id:Date.now(), name, category:cat, price, sku:document.getElementById('f_sku').value.trim(), desc:document.getElementById('f_desc').value.trim()||'Commercial-grade restaurant equipment.', images:[...uploadedImages], icon:icons[cat]||'üì¶', specs, badge:'New' });
    showToast('‚úÖ Product listed successfully!');
  }
  closeAdminPanel();
  renderAdminProducts();
  renderAdminStats();
  renderProducts(getFiltered());
}

function promptDelete(id) {
  deleteProductId = id;
  document.getElementById('confirmOverlay').classList.add('open');
}
function closeConfirm() {
  deleteProductId = null;
  document.getElementById('confirmOverlay').classList.remove('open');
}
function confirmDelete() {
  if (!deleteProductId) return;
  products = products.filter(p => p.id !== deleteProductId);
  closeConfirm();
  renderAdminProducts();
  renderAdminStats();
  renderProducts(getFiltered());
  showToast('üóë Product removed.');
}

// ======= ORDERS TABLE =======
function renderOrdersTable() {
  const statusMap = {processing:'processing',shipped:'shipped',delivered:'delivered',pending:'pending'};
  document.getElementById('ordersTableBody').innerHTML = ORDERS.map(o => `
    <div class="table-row orders-cols">
      <span class="order-num">${o.id}</span>
      <span><strong>${o.customer}</strong><br><span style="font-size:12px;color:var(--muted)">${o.items.join(', ')}</span></span>
      <span>${o.date}</span>
      <span><strong>$${o.total.toLocaleString()}</strong></span>
      <span><span class="status-pill ${statusMap[o.status]||'processing'}">${o.status}</span></span>
      <span>
        <select style="padding:4px 8px;border:1px solid var(--border);border-radius:5px;font-size:12px;outline:none;" onchange="updateOrderStatus('${o.id}',this.value)">
          <option ${o.status==='pending'?'selected':''}>pending</option>
          <option ${o.status==='processing'?'selected':''}>processing</option>
          <option ${o.status==='shipped'?'selected':''}>shipped</option>
          <option ${o.status==='delivered'?'selected':''}>delivered</option>
        </select>
      </span>
    </div>`).join('');
}

function updateOrderStatus(id, newStatus) {
  const o = ORDERS.find(x => x.id === id);
  if (o) { o.status = newStatus; renderOrdersTable(); showToast(`üìã Order ${id} updated to "${newStatus}"`); }
}

// ======= CUSTOMERS TABLE =======
function renderCustomersTable() {
  document.getElementById('customersTableBody').innerHTML = CUSTOMERS.map((c,i) => `
    <div class="table-row customers-cols">
      <span style="color:var(--muted);font-weight:600;">${i+1}</span>
      <span><strong>${c.name}</strong><br><span style="font-size:12px;color:var(--muted)">${c.email}</span></span>
      <span style="font-family:'Barlow Condensed',sans-serif;font-weight:700;color:var(--accent)">${c.orderKey}</span>
      <span>${ORDERS.filter(o=>o.customerId===c.id).length}</span>
      <span><span class="status-pill delivered">Active</span></span>
    </div>`).join('');
}

// ======= CUSTOMER PORTAL =======
function renderCustomerPortal() {
  if (!currentUser || currentUser.role !== 'customer') return;
  const myOrders = ORDERS.filter(o => o.customerId === currentUser.id);
  const myWarranties = WARRANTIES[currentUser.id] || [];

  // Orders
  document.getElementById('customerOrders').innerHTML = myOrders.map(o => `
    <div class="order-card">
      <div class="order-card-header">
        <div>
          <div class="order-id">${o.id}</div>
          <div class="order-date">Placed: ${o.date}</div>
        </div>
        <span class="status-pill ${o.status}">${o.status}</span>
      </div>
      <div class="order-items-list">üõí ${o.items.join(' &nbsp;¬∑&nbsp; ')}</div>
      <div class="order-total-row">
        <span>Order Total</span>
        <span>$${o.total.toLocaleString()}</span>
      </div>
      <div class="portal-actions">
        ${o.tracking ? `<button class="portal-btn primary" onclick="toggleTracking('tracking-${o.id}')">üìç Track Shipment</button>` : '<span style="font-size:13px;color:var(--muted);">üì¶ Awaiting shipment</span>'}
        <button class="portal-btn" onclick="showToast('üìÑ Invoice for ${o.id} downloaded!')">üìÑ Invoice</button>
        ${o.status === 'delivered' ? `<button class="portal-btn" onclick="showToast('üîß Support ticket opened for ${o.id}')">üîß Request Service</button>` : ''}
      </div>
      <div class="tracking-box" id="tracking-${o.id}">
        ${o.tracking ? `<div style="font-size:12px;color:var(--muted);margin-bottom:4px;">TRACKING NUMBER</div>
        <div class="tracking-number">${o.tracking}</div>
        <div class="tracking-steps" style="margin-top:16px;">
          ${o.trackingSteps.map(s => `
            <div class="tracking-step">
              <div class="step-dot ${s.done?'done':(s.active?'active':'pending')}">${s.done?'‚úì':''}</div>
              <div class="step-info">
                <div class="step-label">${s.label}</div>
                <div class="step-date">${s.date}</div>
              </div>
            </div>`).join('')}
        </div>` : '<p style="color:var(--muted);font-size:13px;">Tracking info not yet available.</p>'}
      </div>
    </div>`).join('');

  // Warranties
  document.getElementById('customerWarranty').innerHTML = myWarranties.map(w => {
    const pct = Math.min(100, Math.round((w.elapsed / w.durationMonths) * 100));
    const remaining = w.durationMonths - w.elapsed;
    const fillClass = pct >= 80 ? 'expired' : pct >= 60 ? 'expiring' : '';
    return `
      <div class="warranty-card">
        <div class="warranty-card-header">
          <div class="warranty-product">${w.product}</div>
          <span class="status-pill ${w.status==='active'?'shipped':(w.status==='pending'?'processing':'pending')}">${w.status}</span>
        </div>
        <div class="warranty-details">
          <strong>Serial:</strong> ${w.serial} &nbsp;¬∑&nbsp;
          <strong>Order:</strong> ${w.orderId} &nbsp;¬∑&nbsp;
          <strong>Coverage:</strong> ${w.startDate} ‚Äì ${w.endDate}
        </div>
        <div class="warranty-bar-wrap">
          <div class="warranty-bar-label">
            <span>${w.elapsed} of ${w.durationMonths} months elapsed</span>
            <span>${remaining} months remaining</span>
          </div>
          <div class="warranty-bar"><div class="warranty-fill ${fillClass}" style="width:${pct}%"></div></div>
        </div>
        <div class="portal-actions" style="margin-top:10px;">
          <button class="portal-btn" onclick="showToast('üìã Warranty certificate for ${w.product} downloaded!')">üìã Certificate</button>
          <button class="portal-btn" onclick="showToast('üîß Warranty claim submitted for ${w.product}!')">üîß File Claim</button>
        </div>
      </div>`;
  }).join('');
}

function toggleTracking(id) {
  document.getElementById(id).classList.toggle('open');
}

// ======= CONFIGURATOR DATA =======
const CONFIGURATOR_MODELS = [
  {
    id: 'display-case-1',
    name: 'Refrigerated Display Case 1200L',
    category: 'Display Cases',
    basePrice: 4200,
    leadTimeDays: 14,
    widths: [850, 1250, 1650, 2050],
    defaultWidth: 1250,
    depth: 720,
    height: 1200,
    panelColors: ['9005', '9016', '1028', '5015'], // RAL codes: Black, White, Yellow, Sky Blue
    customizations: [
      { id: 'glass-type', name: 'Glass Type', options: [
        { id: 'high-glass', name: 'High Glass (Full)', priceAdj: 0 },
        { id: 'low-glass', name: 'Low Glass (Bottom)', priceAdj: -300 }
      ]},
      { id: 'bottom-type', name: 'Bottom Panel', options: [
        { id: 'solid-panel', name: 'Solid Panel', priceAdj: 0 },
        { id: 'glass-panel', name: 'Glass Panel', priceAdj: 400 }
      ]}
    ]
  },
  {
    id: 'grab-go-1',
    name: 'Grab & Go Cooler 1000R',
    category: 'Grab & Go',
    basePrice: 3800,
    leadTimeDays: 10,
    widths: [850, 1250, 1650, 2050],
    defaultWidth: 1250,
    depth: 650,
    height: 1400,
    panelColors: ['9005', '9016', '1028'],
    customizations: [
      { id: 'door-config', name: 'Door Configuration', options: [
        { id: 'single-door', name: 'Single Door', priceAdj: 0 },
        { id: 'double-doors', name: 'Double Doors', priceAdj: 350 },
        { id: 'triple-doors', name: 'Triple Doors', priceAdj: 700 }
      ]},
      { id: 'side-panels', name: 'Side Panels', options: [
        { id: 'solid-sides', name: 'Solid Sides', priceAdj: 0 },
        { id: 'glass-sides', name: 'Glass Sides', priceAdj: 500 }
      ]}
    ]
  }
];

let currentConfig = {
  modelId: null,
  width: null,
  panelColor: '9005',
  customizations: {},
  quantity: 1,
  channeled: false,
  price: 0,
  leadTime: 0
};

// Load 3D models from localStorage
if (localStorage.getItem('configuratorModels')) {
  try {
    const savedModels = JSON.parse(localStorage.getItem('configuratorModels'));
    console.log('üì¶ Loaded', savedModels.length, 'models from localStorage');
    savedModels.forEach(m => {
      console.log('  - Model:', m.name, '| useGLTF:', m.useGLTF, '| baseModel:', !!m.baseModel, '| size:', m.baseModel ? (m.baseModel.length / 1024).toFixed(0) + 'KB' : 'N/A');
    });
    CONFIGURATOR_MODELS.length = 0;
    CONFIGURATOR_MODELS.push(...savedModels);
  } catch (e) {
    console.error('‚ùå Failed to load models from localStorage:', e);
  }
}

let configuratorScene = null;
let configuratorCamera = null;
let configuratorRenderer = null;
let configuratorModel = null;
let gltfLoader = null;
let configuratorControls = null;
let configuratorDrag = { active: false, lastX: 0, lastY: 0, mode: 'rotate' };
let configuratorRoom = null;
let threeExtrasPromise = null;
let dracoLoader = null;
const USE_APS_VIEWER = true;
let apsViewer = null;
let apsViewerReady = false;
let apsCurrentUrn = null;
const APS_API_BASE = window.APS_API_BASE || 'http://localhost:8787';

function ensureApsViewer() {
  if (!USE_APS_VIEWER) {
    return Promise.resolve(false);
  }
  if (apsViewerReady && apsViewer) {
    return Promise.resolve(true);
  }
  if (!window.Autodesk || !Autodesk.Viewing) {
    console.warn('‚ö†Ô∏è Autodesk Viewer not available');
    return Promise.resolve(false);
  }

  return new Promise((resolve) => {
    const options = {
      env: 'AutodeskProduction',
      getAccessToken: async (onTokenReady) => {
        try {
          const res = await fetch(APS_API_BASE + '/api/aps/token');
          const data = await res.json();
          onTokenReady(data.access_token, data.expires_in);
        } catch (error) {
          console.error('‚ùå Failed to fetch APS token:', error);
        }
      }
    };

    Autodesk.Viewing.Initializer(options, () => {
      const viewerDiv = document.getElementById('apsViewer');
      apsViewer = new Autodesk.Viewing.GuiViewer3D(viewerDiv);
      apsViewer.start();
      apsViewerReady = true;
      resolve(true);
    });
  });
}

async function uploadDwgForViewer(event) {
  const file = event.target.files[0];
  if (!file) return;

  const statusEl = document.getElementById('testStatus');
  statusEl.textContent = 'Uploading DWG...';
  statusEl.style.color = '#856404';

  const ready = await ensureApsViewer();
  if (!ready) {
    statusEl.textContent = '‚ùå Viewer not available.';
    statusEl.style.color = 'red';
    return;
  }

  const form = new FormData();
  form.append('file', file);

  try {
    const res = await fetch(APS_API_BASE + '/api/aps/upload-translate', {
      method: 'POST',
      body: form
    });
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || 'Upload failed');
    }

    apsCurrentUrn = data.urn;
    statusEl.textContent = 'Translating...';
    await waitForTranslation(apsCurrentUrn, statusEl);
    await loadApsUrn(apsCurrentUrn, statusEl);
  } catch (error) {
    console.error('‚ùå DWG upload failed:', error);
    statusEl.textContent = '‚ùå Upload failed: ' + error.message;
    statusEl.style.color = 'red';
  }
}

async function waitForTranslation(urn, statusEl) {
  const maxAttempts = 60;
  for (let i = 0; i < maxAttempts; i++) {
    const res = await fetch(`${APS_API_BASE}/api/aps/manifest/${encodeURIComponent(urn)}`);
    const data = await res.json();
    if (data.status === 'success') {
      statusEl.textContent = '‚úÖ Translation complete';
      return;
    }
    if (data.status === 'failed') {
      throw new Error('Translation failed');
    }
    const progress = data.progress || 'In progress';
    statusEl.textContent = 'Translating... ' + progress;
    await new Promise(resolve => setTimeout(resolve, 2000));
  }
  throw new Error('Translation timed out');
}

async function loadApsUrn(urn, statusEl) {
  if (!apsViewer || !apsViewerReady) {
    throw new Error('Viewer not ready');
  }

  statusEl.textContent = 'Loading into viewer...';
  return new Promise((resolve, reject) => {
    Autodesk.Viewing.Document.load(
      'urn:' + urn,
      (doc) => {
        const defaultViewable = doc.getRoot().getDefaultGeometry();
        const viewable = defaultViewable || doc.getRoot().search({ type: 'geometry' })[0];
        if (!viewable) {
          reject(new Error('No viewable geometry found'));
          return;
        }
        apsViewer.loadDocumentNode(doc, viewable).then(() => {
          statusEl.textContent = '‚úÖ DWG loaded!';
          statusEl.style.color = 'green';
          resolve();
        }).catch(reject);
      },
      (err) => reject(new Error(err))
    );
  });
}

function ensureThreeExtrasLoaded() {
  if (typeof THREE === 'undefined') {
    console.warn('‚ö†Ô∏è THREE not available - cannot load GLTFLoader');
    return Promise.resolve(false);
  }
  if (THREE.GLTFLoader && THREE.OrbitControls) {
    return Promise.resolve(true);
  }
  if (threeExtrasPromise) {
    return threeExtrasPromise;
  }
  threeExtrasPromise = new Promise((resolve) => {
    let pending = 0;
    const base = 'https://unpkg.com/three@0.128.0/examples/js';

    const loadScript = (src) => {
      pending += 1;
      const script = document.createElement('script');
      script.src = src;
      script.onload = () => {
        pending -= 1;
        if (pending === 0) {
          resolve(!!THREE.GLTFLoader && !!THREE.OrbitControls);
        }
      };
      script.onerror = () => {
        pending -= 1;
        console.warn('‚ö†Ô∏è Failed to load:', src);
        if (pending === 0) {
          resolve(!!THREE.GLTFLoader && !!THREE.OrbitControls);
        }
      };
      document.head.appendChild(script);
    };

    if (!THREE.GLTFLoader) {
      loadScript(base + '/loaders/GLTFLoader.js');
    }
    if (!THREE.OrbitControls) {
      loadScript(base + '/controls/OrbitControls.js');
    }
    if (!THREE.DRACOLoader) {
      loadScript(base + '/loaders/DRACOLoader.js');
    }
    if (!window.MeshoptDecoder) {
      loadScript(base + '/libs/meshopt_decoder.js');
    }

    if (pending === 0) {
      resolve(true);
    }
  });

  return threeExtrasPromise;
}

function configureGltfLoader() {
  if (!gltfLoader || typeof THREE === 'undefined') {
    return;
  }
  if (THREE.DRACOLoader && !dracoLoader) {
    dracoLoader = new THREE.DRACOLoader();
    dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
    gltfLoader.setDRACOLoader(dracoLoader);
  }
  if (window.MeshoptDecoder) {
    gltfLoader.setMeshoptDecoder(window.MeshoptDecoder);
  }
}

function frameConfiguratorObject(object3d) {
  if (!configuratorCamera || !object3d) {
    return;
  }
  const box = new THREE.Box3().setFromObject(object3d);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());
  const maxDim = Math.max(size.x, size.y, size.z);
  if (!isFinite(maxDim) || maxDim <= 0) {
    console.warn('‚ö†Ô∏è Cannot frame model: invalid bounds');
    return;
  }

  const fov = configuratorCamera.fov * (Math.PI / 180);
  let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
  cameraZ *= 1.6;

  configuratorCamera.position.set(center.x, center.y + maxDim * 0.2, center.z + cameraZ);
  configuratorCamera.near = Math.max(0.01, maxDim / 100);
  configuratorCamera.far = maxDim * 100;
  configuratorCamera.updateProjectionMatrix();

  if (configuratorControls) {
    configuratorControls.target.copy(center);
    configuratorControls.update();
  } else {
    configuratorCamera.lookAt(center);
  }
}

function showConfigurator() {
  document.getElementById('storefrontView').style.display = 'none';
  document.getElementById('adminView').style.display = 'none';
  document.getElementById('customerPortalView').style.display = 'none';
  document.getElementById('configuratorView').style.display = 'block';
  
  // Give DOM time to reflow, then trigger resize
  setTimeout(() => {
    window.dispatchEvent(new Event('resize'));
    if (apsViewer) {
      apsViewer.resize();
    }
    if (configuratorCamera && configuratorRenderer) {
      configuratorCamera.aspect = window.innerWidth / window.innerHeight;
      configuratorCamera.updateProjectionMatrix();
    }
  }, 100);
  
  initConfigurator();
  window.scrollTo(0, 0);
}

function initConfigurator() {
  console.log('=== initConfigurator called ===');
  // Restore saved 3D models and variants from localStorage
  const savedModels = localStorage.getItem('configuratorModels');
  if (savedModels) {
    try {
      const parsedModels = JSON.parse(savedModels);
      parsedModels.forEach(m => {
        if (!CONFIGURATOR_MODELS.find(x => x.id === m.id)) {
          CONFIGURATOR_MODELS.push(m);
        }
      });
    } catch (e) {
      console.log('Could not restore models from localStorage');
    }
  }
  
  const savedVariants = localStorage.getItem('variantFiles');
  if (savedVariants) {
    try {
      variantFiles = JSON.parse(savedVariants);
    } catch (e) {
      console.log('Could not restore variant files from localStorage');
    }
  }
  
  // Populate model selector
  const modelSelect = document.getElementById('modelSelect');
  modelSelect.innerHTML = '<option value="">Choose a model...</option>' + 
    CONFIGURATOR_MODELS.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
  
  if (USE_APS_VIEWER) {
    ensureApsViewer();
  } else {
    // Initialize Three.js scene if not already done
    if (!configuratorScene) {
      initThreeJS();
    }
    
    // Initialize GLTFLoader - load fallback if needed
    ensureThreeExtrasLoaded().then((ready) => {
      if (ready && !gltfLoader) {
        gltfLoader = new THREE.GLTFLoader();
        configureGltfLoader();
        console.log('‚úì GLTFLoader initialized');
      } else if (ready && gltfLoader) {
        configureGltfLoader();
      } else if (!ready) {
        console.warn('‚ö†Ô∏è GLTFLoader not available - check if script loaded');
      }
    });
  }
  
  // Auto-select first model for testing
  if (!modelSelect.value && CONFIGURATOR_MODELS.length > 0) {
    modelSelect.value = CONFIGURATOR_MODELS[0].id;
    console.log('Auto-selected first model:', CONFIGURATOR_MODELS[0].id);
    updateConfigurator();
  }
}

function initThreeJS() {
  console.log('=== initThreeJS START ===');
  console.log('THREE.js loaded?', typeof THREE !== 'undefined');
  console.log('THREE.Scene:', typeof THREE.Scene);
  
  const canvas = document.getElementById('configuratorCanvas');
  if (!canvas) {
    console.error('CANVAS NOT FOUND!');
    return;
  }
  
  // Use the rendered canvas size
  const rect = canvas.getBoundingClientRect();
  const width = Math.max(300, Math.floor(rect.width));
  const height = Math.max(300, Math.floor(rect.height));
  console.log('Using canvas size:', width, 'x', height);
  
  // Clear and set canvas size explicitly
  canvas.width = width;
  canvas.height = height;
  canvas.style.display = 'block';
  canvas.style.pointerEvents = 'auto';
  
  try {
    configuratorScene = new THREE.Scene();
    console.log('‚úì Scene created');
  } catch(e) {
    console.error('FAILED to create scene:', e);
    return;
  }
  
  configuratorScene.background = new THREE.Color(0xf5f5f0);
  
  try {
    configuratorCamera = new THREE.PerspectiveCamera(65, 1.0, 0.1, 1000);
    configuratorCamera.position.set(0, 1.2, 3.2);
    configuratorCamera.lookAt(0, 0.6, 0);
    console.log('‚úì Camera created');
  } catch(e) {
    console.error('FAILED to create camera:', e);
    return;
  }
  
  try {
    configuratorRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
    console.log('‚úì WebGL Renderer created');
  } catch(e) {
    console.error('FAILED to create renderer:', e);
    return;
  }
  
  configuratorRenderer.setSize(width, height, false);
  configuratorRenderer.setPixelRatio(window.devicePixelRatio || 1);
  configuratorRenderer.shadowMap.enabled = true;
  configuratorRenderer.shadowMap.type = THREE.PCFShadowMap;
  console.log('‚úì Renderer configured');

  if (THREE.OrbitControls) {
    configuratorControls = new THREE.OrbitControls(configuratorCamera, configuratorRenderer.domElement);
    configuratorControls.enableDamping = true;
    configuratorControls.dampingFactor = 0.08;
    configuratorControls.enableRotate = true;
    configuratorControls.enablePan = true;
    configuratorControls.enableZoom = true;
    configuratorControls.zoomSpeed = 0.9;
    configuratorControls.minDistance = 1.6;
    configuratorControls.maxDistance = 6.0;
    configuratorControls.maxPolarAngle = Math.PI / 2.1;
    configuratorControls.target.set(0, 0.6, 0);
    configuratorControls.update();

    // Enable controls only when hovering over the canvas
    configuratorControls.enabled = false;
    canvas.addEventListener('mouseenter', () => { configuratorControls.enabled = true; });
    canvas.addEventListener('mouseleave', () => { configuratorControls.enabled = false; });
  } else {
    console.warn('OrbitControls not available; mouse controls disabled.');
  }

  // Fallback: basic drag-to-rotate on the model itself
  canvas.style.cursor = 'grab';
  canvas.addEventListener('wheel', (event) => {
    if (configuratorControls && configuratorControls.enabled) return;
    if (!configuratorCamera) return;
    event.preventDefault();
    const zoomDelta = Math.sign(event.deltaY) * 0.2;
    const dir = new THREE.Vector3();
    configuratorCamera.getWorldDirection(dir);
    configuratorCamera.position.addScaledVector(dir, zoomDelta);
  }, { passive: false });

  canvas.addEventListener('contextmenu', (event) => event.preventDefault());
  canvas.addEventListener('mousedown', (event) => {
    configuratorDrag.active = true;
    configuratorDrag.lastX = event.clientX;
    configuratorDrag.lastY = event.clientY;
    configuratorDrag.mode = event.button === 2 ? 'pan' : 'rotate';
    canvas.style.cursor = 'grabbing';
  });
  window.addEventListener('mouseup', () => {
    configuratorDrag.active = false;
    canvas.style.cursor = 'grab';
  });
  window.addEventListener('mousemove', (event) => {
    if (configuratorControls && configuratorControls.enableRotate) return;
    if (!configuratorDrag.active || !configuratorRoom) return;
    const deltaX = event.clientX - configuratorDrag.lastX;
    const deltaY = event.clientY - configuratorDrag.lastY;
    configuratorDrag.lastX = event.clientX;
    configuratorDrag.lastY = event.clientY;

    if (configuratorDrag.mode === 'pan') {
      configuratorRoom.position.x += deltaX * 0.004;
      configuratorRoom.position.z += deltaY * 0.004;
    } else {
      configuratorRoom.rotation.y += deltaX * 0.005;
      configuratorRoom.rotation.x = Math.max(-0.2, Math.min(0.3, configuratorRoom.rotation.x + deltaY * 0.002));
    }
  });
  
  // Professional Lighting Setup
  // Soft ambient light for overall illumination
  const ambLight = new THREE.AmbientLight(0xffffff, 0.7);
  configuratorScene.add(ambLight);
  console.log('‚úì Ambient light added');
  
  // Key light (main directional light from upper right)
  const keyLight = new THREE.DirectionalLight(0xffffff, 1.2);
  keyLight.position.set(4, 5, 4);
  keyLight.castShadow = true;
  keyLight.shadow.mapSize.width = 2048;
  keyLight.shadow.mapSize.height = 2048;
  keyLight.shadow.camera.far = 20;
  keyLight.shadow.camera.left = -8;
  keyLight.shadow.camera.right = 8;
  keyLight.shadow.camera.top = 8;
  keyLight.shadow.camera.bottom = -8;
  keyLight.shadow.bias = -0.0001;
  configuratorScene.add(keyLight);
  console.log('‚úì Key light added');
  
  // Fill light (softer light from opposite side for ambient fill)
  const fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
  fillLight.position.set(-3, 3, -2);
  configuratorScene.add(fillLight);
  console.log('‚úì Fill light added');
  
  // Back light for depth and rim lighting
  const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
  backLight.position.set(0, 2.5, -5);
  configuratorScene.add(backLight);
  console.log('‚úì Back light added');
  
  // START RENDER LOOP
  console.log('Starting render loop...');
  let renderCount = 0;
  function animate() {
    renderCount++;
    if (renderCount === 1) {
      console.log('*** FIRST RENDER FRAME ***');
      console.log('Scene children:', configuratorScene.children.length);
      console.log('Camera:', configuratorCamera.position);
      console.log('Renderer:', configuratorRenderer.domElement);
    }
    
    requestAnimationFrame(animate);
    
    if (configuratorControls) {
      configuratorControls.update();
    }
    
    configuratorRenderer.render(configuratorScene, configuratorCamera);
  }
  
  animate();
  console.log('=== initThreeJS END ===');
}

function updateConfigurator() {
  const modelId = document.getElementById('modelSelect').value;
  if (!modelId) return;
  
  const model = CONFIGURATOR_MODELS.find(m => m.id === modelId);
  if (!model) return;
  
  currentConfig.modelId = modelId;
  currentConfig.width = model.defaultWidth;
  currentConfig.panelColor = model.panelColors[0];
  currentConfig.customizations = {};
  currentConfig.quantity = 1;
  currentConfig.channeled = false;
  
  // Show/hide relevant sections
  document.getElementById('sizeSection').style.display = 'block';
  document.getElementById('quantitySection').style.display = 'block';
  document.getElementById('panelColorSection').style.display = 'block';
  document.getElementById('customOptionsSection').style.display = 'block';
  
  // Setup size buttons
  document.querySelectorAll('.config-btn[data-size]').forEach(btn => {
    btn.classList.remove('active');
    if (parseInt(btn.getAttribute('data-size')) === model.defaultWidth) {
      btn.classList.add('active');
    }
  });

  // Setup quantity buttons
  document.querySelectorAll('.config-btn[data-qty]').forEach(btn => {
    btn.classList.remove('active');
    if (parseInt(btn.getAttribute('data-qty')) === 1) {
      btn.classList.add('active');
    }
  });
  const channeledBtn = document.getElementById('channeledBtn');
  if (channeledBtn) channeledBtn.classList.remove('active');
  
  // Setup color picker
  setupColorPicker(model.panelColors);
  
  // Setup customization options
  setupCustomizations(model);
  
  // Create 3D model
  if (!USE_APS_VIEWER) {
    console.log('üìê updateConfigurator calling createDisplayCaseModel');
    console.log('   Selected model:', model.name, '(ID:', model.id + ')');
    createDisplayCaseModel(model, model.defaultWidth);
  }
  
  // Update price and lead time
  updateConfigPrice();
}

function setupColorPicker(ralCodes) {
  const grid = document.getElementById('colorPickerGrid');
  const ralColorMap = {
    '9005': '#010a12', // Black
    '9016': '#f8f8f8', // White
    '1028': '#f4d60b', // Yellow
    '5015': '#87ceeb', // Sky Blue
    '3004': '#5a0a0a', // Dark Red
    '6024': '#498b3e', // Green
    '2004': '#ff6600', // Orange
  };
  
  grid.innerHTML = ralCodes.map(code => `
    <div class="color-swatch ${code === currentConfig.panelColor ? 'active' : ''}" 
         style="background-color: ${ralColorMap[code] || '#cccccc'}" 
         data-ral="${code}" 
         onclick="setColorOption(this, '${code}')"
         title="RAL ${code}"></div>
  `).join('');
}

function setColorOption(el, ralCode) {
  document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  currentConfig.panelColor = ralCode;
  updatePanelColor(ralCode);
  updateConfigPrice();
}

function applyCustomRalColor() {
  const code = document.getElementById('ralInput').value.trim();
  if (!/^\d{4}$/.test(code)) {
    alert('Please enter a valid 4-digit RAL code (e.g., 9005)');
    return;
  }
  currentConfig.panelColor = code;
  updatePanelColor(code);
  updateConfigPrice();
  alert(`Applied RAL ${code}`);
}

function setSizeOption(el) {
  document.querySelectorAll('.config-btn[data-size]').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  const newWidth = parseInt(el.getAttribute('data-size'));
  currentConfig.width = newWidth;
  
  const model = CONFIGURATOR_MODELS.find(m => m.id === currentConfig.modelId);
  if (model && !USE_APS_VIEWER) {
    createDisplayCaseModel(model, newWidth);
  }
  updateConfigPrice();
}

function setQuantityOption(el) {
  document.querySelectorAll('.config-btn[data-qty]').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  const newQty = parseInt(el.getAttribute('data-qty'));
  currentConfig.quantity = newQty;

  const model = CONFIGURATOR_MODELS.find(m => m.id === currentConfig.modelId);
  if (model && !USE_APS_VIEWER) {
    createDisplayCaseModel(model, currentConfig.width);
  }
  updateConfigPrice();
}

function toggleChanneled(btn) {
  const isActive = btn.classList.toggle('active');
  currentConfig.channeled = isActive;

  const model = CONFIGURATOR_MODELS.find(m => m.id === currentConfig.modelId);
  if (model && !USE_APS_VIEWER) {
    createDisplayCaseModel(model, currentConfig.width);
  }
}

function setupCustomizations(model) {
  const container = document.getElementById('customOptionsContainer');
  container.innerHTML = '';
  
  model.customizations.forEach(group => {
    const section = document.createElement('div');
    section.style.marginBottom = '16px';
    section.innerHTML = `<label class="config-label" style="margin-bottom: 8px;">${group.name}</label>`;
    
    const buttons = document.createElement('div');
    buttons.style.display = 'grid';
    buttons.style.gridTemplateColumns = '1fr 1fr';
    buttons.style.gap = '8px';
    
    group.options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'config-btn';
      btn.textContent = opt.name;
      btn.onclick = () => selectCustomization(group.id, opt.id, btn);
      buttons.appendChild(btn);
    });
    
    section.appendChild(buttons);
    container.appendChild(section);
  });
}

function selectCustomization(groupId, optionId, btn) {
  btn.parentElement.querySelectorAll('.config-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentConfig.customizations[groupId] = optionId;
  updateConfigPrice();
  updatePanelColor(currentConfig.panelColor);
}

function loadVariantModel(variantData) {
  // Parse data URL to blob
  const arr = variantData.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  const n = bstr.length;
  const u8arr = new Uint8Array(n);
  for (let i = 0; i < n; i++) {
    u8arr[i] = bstr.charCodeAt(i);
  }
  const blob = new Blob([u8arr], { type: mime });
  const url = URL.createObjectURL(blob);
  
  if (gltfLoader && configuratorModel) {
    gltfLoader.load(url, (gltf) => {
      // Find and replace matching mesh in the model
      gltf.scene.traverse((child) => {
        if (child.isMesh) {
          child.castShadow = true;
          child.receiveShadow = true;
        }
      });
      // For now, just add the loaded model as an overlay
      // In production, you'd identify specific parts to swap
      const loadedModel = gltf.scene;
      loadedModel.position.copy(configuratorModel.position);
      loadedModel.rotation.copy(configuratorModel.rotation);
      URL.revokeObjectURL(url);
    });
  }
}

function createDisplayCaseModel(model, width) {
  // Make sure scene exists
  console.log('üîç createDisplayCaseModel called');
  console.log('  Model name:', model.name);
  console.log('  Model ID:', model.id);
  console.log('  Width:', width);
  console.log('  model.useGLTF:', model.useGLTF);
  console.log('  model.baseModel exists:', !!model.baseModel);
  console.log('  model.baseModel length:', model.baseModel ? model.baseModel.length : 0);
  console.log('  model.baseFileName:', model.baseFileName);
  console.log('  gltfLoader exists:', !!gltfLoader);
  console.log('  configuratorScene exists:', !!configuratorScene);
  
  if (!configuratorScene) {
    console.error('‚ùå Scene not initialized!');
    return;
  }
  
  // Ensure room group exists
  if (!configuratorRoom) {
    configuratorRoom = new THREE.Group();
    configuratorRoom.name = 'roomGroup';
    configuratorScene.add(configuratorRoom);
    console.log('‚úì Created room group');
  }

  // Remove old model
  if (configuratorModel && configuratorRoom) {
    configuratorRoom.remove(configuratorModel);
    console.log('‚úì Removed old model from room');
  }
  
  configuratorModel = new THREE.Group();
  configuratorRoom.add(configuratorModel);
  console.log('‚úì Created new model group and added to room');
  
  // Check if this model has an uploaded GLTF file (admin-uploaded)
  if (model.useGLTF && model.baseModel && gltfLoader) {
    console.log('üé® Loading admin-uploaded 3D model:', model.name);
    loadGLTFModel(model.baseModel, model.baseFileName);
  } else {
    if (!model.useGLTF) {
      console.log('‚ö†Ô∏è Model does not have useGLTF flag');
    }
    if (!model.baseModel) {
      console.log('‚ö†Ô∏è Model does not have baseModel data');
    }
    if (!gltfLoader) {
      console.log('‚ö†Ô∏è GLTFLoader not initialized');
    }
    // Use procedural models as default
    console.log('üî® Creating procedural model (fallback)');
    createProceduralModel(width, currentConfig.quantity || 1);
  }
}

function loadGLTFModel(modelData, fileName) {
  console.log('üì• loadGLTFModel called for:', fileName);
  console.log('  modelData:', !!modelData);
  console.log('  gltfLoader:', !!gltfLoader);
  console.log('  configuratorModel:', !!configuratorModel);
  console.log('  configuratorRoom:', !!configuratorRoom);
  
  if (!modelData) {
    console.error('‚ùå No model data');
    return;
  }
  
  if (!gltfLoader) {
    console.error('‚ùå GLTFLoader not initialized');
    return;
  }
  
  if (!configuratorModel) {
    console.error('‚ùå Configurator model group not ready');
    return;
  }
  
  try {
    console.log('üîç Attempting to parse base64 data...');
    console.log('  Data starts with:', modelData.substring(0, 50));
    
    // Check if it's a data URL
    if (!modelData.startsWith('data:')) {
      console.error('‚ùå Invalid data format - not a data URL');
      alert('Error: Model data is not in data URL format');
      createProceduralModel(currentConfig.width || 1250, currentConfig.quantity || 1);
      return;
    }
    
    // Convert base64 data URL to blob
    const arr = modelData.split(',');
    if (arr.length < 2) {
      console.error('‚ùå Invalid data URL format');
      alert('Error: Model data URL is malformed');
      createProceduralModel(currentConfig.width || 1250, currentConfig.quantity || 1);
      return;
    }
    
    const mimeMatch = arr[0].match(/:(.*?);/);
    if (!mimeMatch) {
      console.error('‚ùå Could not extract MIME type');
      alert('Error: Could not determine file type from data');
      createProceduralModel(currentConfig.width || 1250, currentConfig.quantity || 1);
      return;
    }
    
    const mime = mimeMatch[1];
    console.log('‚úì MIME type:', mime);
    
    const bstr = atob(arr[1]);
    const n = bstr.length;
    console.log('‚úì Decoded', n, 'bytes');
    
    const u8arr = new Uint8Array(n);
    for (let i = 0; i < n; i++) {
      u8arr[i] = bstr.charCodeAt(i);
    }
    const blob = new Blob([u8arr], { type: mime });
    const url = URL.createObjectURL(blob);
    
    console.log('‚úì Created blob URL:', url);
    console.log('‚úì Blob size:', (blob.size / 1024).toFixed(2), 'KB');
    console.log('üöÄ Starting GLTFLoader.load...');
    
    gltfLoader.load(
      url,
      function(gltf) {
        console.log('‚úÖ GLTF loaded successfully!');
        console.log('  Scene children:', gltf.scene ? gltf.scene.children.length : 0);
        
        // Clear existing model group
        while (configuratorModel.children.length > 0) {
          configuratorModel.remove(configuratorModel.children[0]);
        }
        console.log('‚úì Cleared old model');

        // Reset room transform so new models don't inherit old offsets
        configuratorRoom.position.set(0, 0, 0);
        configuratorRoom.rotation.set(0, 0, 0);
        
        // Hide procedural floor and walls when loading custom model
        configuratorRoom.children.forEach(child => {
          if (child.name === 'floor' || child.name === 'walls') {
            child.visible = false;
            console.log('‚úì Hidden', child.name, 'for custom model');
          }
        });
        
        const loadedScene = gltf.scene || (gltf.scenes && gltf.scenes[0]) || new THREE.Group();
        
        // Enable shadows for all meshes
        let meshCount = 0;
        let pointsCount = 0;
        let lineCount = 0;
        loadedScene.traverse((child) => {
          if (child.isMesh) {
            child.castShadow = true;
            child.receiveShadow = true;
            meshCount++;
          } else if (child.isPoints) {
            pointsCount++;
          } else if (child.isLine) {
            lineCount++;
          }
        });
        console.log('‚úì Enabled shadows for', meshCount, 'meshes', pointsCount, 'points', lineCount, 'lines');
        
        if (meshCount === 0) {
          console.warn('‚ö†Ô∏è No meshes found in GLTF model!');
          alert('Warning: No meshes found. If this is a point cloud/lines, it may still render.');
          if (configuratorControls && (pointsCount + lineCount) > 0) {
            configuratorControls.enableRotate = false;
            configuratorControls.update();
            showToast('Line/point model detected. Rotation disabled to keep it visible. Export a mesh for full 3D.');
          }
        }
        
        // Center the model
        const box = new THREE.Box3().setFromObject(loadedScene);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        
        console.log('  Model size:', size.x.toFixed(2), 'x', size.y.toFixed(2), 'x', size.z.toFixed(2));
        console.log('  Model center:', center.x.toFixed(2), center.y.toFixed(2), center.z.toFixed(2));
        
        // Center horizontally and place on floor
        loadedScene.position.x = -center.x;
        loadedScene.position.y = -box.min.y; // Place bottom on y=0
        loadedScene.position.z = -center.z;
        
        // Scale to reasonable size (max dimension = 2 units)
        const maxDim = Math.max(size.x, size.y, size.z);
        console.log('  Max dimension:', maxDim.toFixed(2));
        
        if (maxDim > 2) {
          const scale = 2 / maxDim;
          loadedScene.scale.multiplyScalar(scale);
          console.log('‚úì Scaled model by', scale.toFixed(3));
        } else if (maxDim < 0.1) {
          const scale = 2 / maxDim;
          loadedScene.scale.multiplyScalar(scale);
          console.log('‚úì Model was tiny, scaled up by', scale.toFixed(3));
        }
        
        configuratorModel.add(loadedScene);
        console.log('‚úì Added to model group');
        console.log('‚úì Model group now has', configuratorModel.children.length, 'children');

        frameConfiguratorObject(configuratorModel);
        
        // Add model to room if not already added
        if (!configuratorModel.parent) {
          configuratorRoom.add(configuratorModel);
          console.log('‚úì Added model to room');
        }
        
        // Ensure room is in scene
        if (!configuratorRoom.parent) {
          configuratorScene.add(configuratorRoom);
          console.log('‚úì Added room to scene');
        }
        
        URL.revokeObjectURL(url);
        console.log('‚úÖ Admin 3D model fully loaded and displayed!');
      },
      function(xhr) {
        if (xhr.total > 0) {
          const progress = (xhr.loaded / xhr.total * 100).toFixed(0);
          console.log('‚è≥ Loading progress:', progress + '%');
        }
      },
      function(error) {
        console.error('‚ùå Error loading GLTF model:', error);
        console.error('  Error type:', error.type);
        console.error('  Error message:', error.message);
        console.error('  Error stack:', error.stack);
        alert('Error loading 3D model. The file may be corrupted or invalid.\n\nError: ' + error.message + '\n\nCheck console for details.');
        URL.revokeObjectURL(url);
        // Fall back to procedural model
        console.log('üî® Falling back to procedural model');
        createProceduralModel(currentConfig.width || 1250, currentConfig.quantity || 1);
      }
    );
  } catch (error) {
    console.error('‚ùå Exception in loadGLTFModel:', error);
    console.error('  Stack:', error.stack);
    alert('Error processing 3D model file: ' + error.message + '\n\nCheck console for details.');
    // Fall back to procedural model
    console.log('üî® Falling back to procedural model');
    createProceduralModel(currentConfig.width || 1250, currentConfig.quantity || 1);
  }
}

// Test function to directly load a model file without storage
async function testLoadModel(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  console.log('üß™ TEST MODE: Direct model load');
  console.log('  File:', file.name);
  console.log('  Size:', (file.size / 1024).toFixed(2), 'KB');
  console.log('  Type:', file.type);
  
  document.getElementById('testStatus').textContent = 'Loading...';
  
  if (!configuratorScene) {
    initThreeJS();
  }
  
  const ready = await ensureThreeExtrasLoaded();
  if (ready && !gltfLoader) {
    gltfLoader = new THREE.GLTFLoader();
    configureGltfLoader();
  } else if (ready && gltfLoader) {
    configureGltfLoader();
  }
  if (!gltfLoader) {
    alert('GLTFLoader not available');
    return;
  }
  
  // Ensure room and model are set up
  if (!configuratorRoom) {
    configuratorRoom = new THREE.Group();
    configuratorRoom.name = 'roomGroup';
    configuratorScene.add(configuratorRoom);
  }
  
  if (!configuratorModel) {
    configuratorModel = new THREE.Group();
    configuratorRoom.add(configuratorModel);
  } else {
    // Clear existing
    while (configuratorModel.children.length > 0) {
      configuratorModel.remove(configuratorModel.children[0]);
    }
  }
  
  // Create blob URL directly from file
  const url = URL.createObjectURL(file);
  console.log('‚úì Created blob URL from file:', url);
  
  gltfLoader.load(
    url,
    function(gltf) {
      console.log('‚úÖ TEST: GLTF loaded successfully!');
      const loadedScene = gltf.scene || (gltf.scenes && gltf.scenes[0]) || new THREE.Group();
      
      // Hide any existing procedural elements
      configuratorRoom.children.forEach(child => {
        if (child.name === 'floor' || child.name === 'walls') {
          child.visible = false;
          console.log('‚úì TEST: Hidden', child.name);
        }
      });

      configuratorRoom.position.set(0, 0, 0);
      configuratorRoom.rotation.set(0, 0, 0);
      
      let meshCount = 0;
      let pointsCount = 0;
      let lineCount = 0;
      loadedScene.traverse((child) => {
        if (child.isMesh) {
          child.castShadow = true;
          child.receiveShadow = true;
          meshCount++;
          console.log('‚úì TEST: Mesh found:', child.name || 'unnamed', 'material:', child.material ? child.material.type : 'none');
        } else if (child.isPoints) {
          pointsCount++;
        } else if (child.isLine) {
          lineCount++;
        }
      });
      console.log('‚úì TEST: Found', meshCount, 'meshes', pointsCount, 'points', lineCount, 'lines');
      
      if (meshCount === 0) {
        console.warn('‚ö†Ô∏è TEST: No meshes found in model!');
        document.getElementById('testStatus').textContent = '‚ö†Ô∏è No meshes detected (points/lines may still render).';
        document.getElementById('testStatus').style.color = 'orange';
        if (configuratorControls && (pointsCount + lineCount) > 0) {
          configuratorControls.enableRotate = false;
          configuratorControls.update();
          document.getElementById('testStatus').textContent = '‚ö†Ô∏è Line/point model detected. Rotation disabled to keep it visible.';
        }
      }
      
      // Center and scale
      const box = new THREE.Box3().setFromObject(loadedScene);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      
      console.log('‚úì TEST: Model size:', size.x.toFixed(2), 'x', size.y.toFixed(2), 'x', size.z.toFixed(2));
      console.log('‚úì TEST: Model bounds min:', box.min.x.toFixed(2), box.min.y.toFixed(2), box.min.z.toFixed(2));
      console.log('‚úì TEST: Model bounds max:', box.max.x.toFixed(2), box.max.y.toFixed(2), box.max.z.toFixed(2));
      
      loadedScene.position.x = -center.x;
      loadedScene.position.y = -box.min.y;
      loadedScene.position.z = -center.z;
      
      const maxDim = Math.max(size.x, size.y, size.z);
      console.log('‚úì TEST: Max dimension:', maxDim.toFixed(2));
      
      if (maxDim > 2) {
        const scale = 2 / maxDim;
        loadedScene.scale.multiplyScalar(scale);
        console.log('‚úì TEST: Scaled by', scale.toFixed(3));
      } else if (maxDim < 0.1) {
        // Model is too small, scale it up
        const scale = 2 / maxDim;
        loadedScene.scale.multiplyScalar(scale);
        console.log('‚úì TEST: Model was tiny, scaled up by', scale.toFixed(3));
      }
      
      configuratorModel.add(loadedScene);
      console.log('‚úì TEST: Added loaded scene to model group');
      console.log('‚úì TEST: Model group now has', configuratorModel.children.length, 'children');
      console.log('‚úì TEST: Model group position:', configuratorModel.position.x, configuratorModel.position.y, configuratorModel.position.z);
      console.log('‚úì TEST: Room group has', configuratorRoom.children.length, 'children');

      frameConfiguratorObject(configuratorModel);
      
      URL.revokeObjectURL(url);
      
      document.getElementById('testStatus').textContent = '‚úÖ Model loaded! Check viewer above.';
      document.getElementById('testStatus').style.color = 'green';
      console.log('‚úÖ TEST: Model successfully displayed!');
      console.log('üìä Final scene hierarchy:');
      console.log('  Scene -> Room ->', configuratorRoom.children.map(c => c.name || c.type).join(', '));
      console.log('  Model group ->', configuratorModel.children.map(c => c.name || c.type).join(', '));
      showToast('‚úÖ Test successful! Model should be visible in viewer.');
    },
    function(xhr) {
      if (xhr.total > 0) {
        const progress = (xhr.loaded / xhr.total * 100).toFixed(0);
        document.getElementById('testStatus').textContent = `Loading... ${progress}%`;
      }
    },
    function(error) {
      console.error('‚ùå TEST: Failed to load model:', error);
      document.getElementById('testStatus').textContent = '‚ùå Failed: ' + error.message;
      document.getElementById('testStatus').style.color = 'red';
      alert('Test failed: ' + error.message + '\n\nYour model file may be corrupted or in an unsupported format.');
      URL.revokeObjectURL(url);
    }
  );
}

function createProceduralModel(width, quantity) {
  console.log('createProceduralModel called, model:', !!configuratorModel, 'scene:', !!configuratorScene);
  if (!configuratorModel || !configuratorScene) {
    console.log('Early return - missing model or scene');
    return;
  }

  const safeQuantity = Math.max(1, quantity || 1);
  
  // Show floor and walls for procedural models
  configuratorRoom.children.forEach(child => {
    if (child.name === 'floor' || child.name === 'walls') {
      child.visible = true;
      console.log('‚úì Made', child.name, 'visible for procedural model');
    }
  });
  
  // Scale the width (normalize to 1250 as 1 unit)
  const widthScale = width / 1250;
  // Apply overall scale multiplier to make model more proportional to room
  const modelScale = 1.8;
  const scaledWidth = widthScale * modelScale;
  const scaledHeight = 1.2 * modelScale;
  const scaledDepth = 0.72 * modelScale;
  
  console.log('Creating procedural model with scaledWidth:', scaledWidth, 'scaledHeight:', scaledHeight, 'scaledDepth:', scaledDepth);
  
  // Add floor plane if not already added
  if (!configuratorRoom.getObjectByName('floor')) {
    const floorGeom = new THREE.PlaneGeometry(13.5, 5.4);
    const floorMat = new THREE.MeshStandardMaterial({ 
      color: 0xf0f0eb,
      metalness: 0.05,
      roughness: 0.9
    });
    const floor = new THREE.Mesh(floorGeom, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -0.6;
    floor.position.z = -0.6;
    floor.receiveShadow = true;
    floor.name = 'floor';
    configuratorRoom.add(floor);
    console.log('Added floor plane');
  }
  
  // Add room walls (very subtle, almost invisible)
  if (!configuratorRoom.getObjectByName('walls')) {
    const wallGeom = new THREE.BoxGeometry(11.25, 4.0, 4.5);
    const wallMat = new THREE.MeshBasicMaterial({ wireframe: false, color: 0xf5f5f0, transparent: true, opacity: 0.0 });
    const walls = new THREE.Mesh(wallGeom, wallMat);
    walls.position.y = 0.8;
    walls.name = 'walls';
    configuratorRoom.add(walls);
    console.log('Added room walls');
  }
  
  const caseGap = 0;
  const totalWidth = (scaledWidth * safeQuantity) + (caseGap * (safeQuantity - 1));
  const startX = -totalWidth / 2 + scaledWidth / 2;

  for (let q = 0; q < safeQuantity; q++) {
    const caseGroup = new THREE.Group();

    // Main case body
    const bodyGeom = new THREE.BoxGeometry(scaledWidth, scaledHeight, scaledDepth);
    const panelMaterial = new THREE.MeshStandardMaterial({ 
      color: getRalColor(currentConfig.panelColor),
      metalness: 0.1,
      roughness: 0.5,
      side: THREE.FrontSide
    });
    const body = new THREE.Mesh(bodyGeom, panelMaterial);
    body.castShadow = true;
    body.receiveShadow = true;
    caseGroup.add(body);
    
    // Glass front with better material
    const glassGeom = new THREE.BoxGeometry(scaledWidth * 0.98, scaledHeight * 0.79, 0.05 * modelScale);
    const glassMaterial = new THREE.MeshStandardMaterial({
      color: 0xf0f8ff,
      metalness: 0.05,
      roughness: 0.15,
      transparent: true,
      opacity: 0.8,
      side: THREE.DoubleSide
    });
    const glass = new THREE.Mesh(glassGeom, glassMaterial);
    glass.position.z = (0.36 * modelScale);
    glass.castShadow = true;
    glass.receiveShadow = true;
    caseGroup.add(glass);
    
    // Bottom shelf with better reflectivity
    const shelfGeom = new THREE.BoxGeometry(scaledWidth * 0.95, 0.02 * modelScale, scaledDepth * 0.9);
    const shelfMat = new THREE.MeshStandardMaterial({ 
      color: 0xf5f5f5,
      metalness: 0.3,
      roughness: 0.6
    });
    const shelf = new THREE.Mesh(shelfGeom, shelfMat);
    shelf.position.y = -0.4 * modelScale;
    shelf.castShadow = true;
    shelf.receiveShadow = true;
    caseGroup.add(shelf);
    
    // Feet with better appearance
    for (let i = 0; i < 4; i++) {
      const footGeom = new THREE.BoxGeometry(0.05 * modelScale, 0.08 * modelScale, 0.05 * modelScale);
      const footMat = new THREE.MeshStandardMaterial({ 
        color: 0x1a1a1a,
        metalness: 0.4,
        roughness: 0.7
      });
      const foot = new THREE.Mesh(footGeom, footMat);
      const xPos = (i < 2 ? -1 : 1) * (scaledWidth / 2 - 0.1 * modelScale);
      const zPos = (i % 2 === 0 ? -1 : 1) * (0.25 * modelScale);
      foot.position.set(xPos, -0.59 * modelScale, zPos);
      foot.castShadow = true;
      foot.receiveShadow = true;
      caseGroup.add(foot);
    }

    caseGroup.position.x = startX + q * (scaledWidth + caseGap);
    configuratorModel.add(caseGroup);
  }
  
  console.log('About to add model to room, room children before:', configuratorRoom.children.length);
  configuratorRoom.add(configuratorModel);
  console.log('Model added to room, room children after:', configuratorRoom.children.length);
  configuratorModel.position.y = 0;
}

function getRalColor(ralCode) {
  const colors = {
    '9005': 0x010a12, // Black
    '9016': 0xf8f8f8, // White
    '1028': 0xf4d60b, // Yellow
    '5015': 0x87ceeb, // Sky Blue
    '3004': 0x5a0a0a, // Dark Red
    '6024': 0x498b3e, // Green
    '2004': 0xff6600, // Orange
  };
  return colors[ralCode] || 0xcccccc;
}

function updatePanelColor(ralCode) {
  if (configuratorModel) {
    // Update all meshes in the model tree
    configuratorModel.traverse((child) => {
      if (child.isMesh && child.material) {
        // Check if this mesh should have the panel color applied
        if (!child.name.toLowerCase().includes('glass') && 
            !child.name.toLowerCase().includes('foot') &&
            !child.name.toLowerCase().includes('shelf')) {
          // Apply color
          if (Array.isArray(child.material)) {
            child.material.forEach(mat => {
              if (mat.color) mat.color.setHex(getRalColor(ralCode));
            });
          } else if (child.material.color) {
            child.material.color.setHex(getRalColor(ralCode));
          }
        }
      }
    });
  }
}

function updateConfigPrice() {
  const model = CONFIGURATOR_MODELS.find(m => m.id === currentConfig.modelId);
  if (!model) return;
  
  let price = model.basePrice * (currentConfig.quantity || 1);
  
  // Add size premium (width increase)
  const sizeAdj = (currentConfig.width - 1250) / 100 * 15;
  price += sizeAdj;
  
  // Add customization prices
  model.customizations.forEach(group => {
    const selectedOptId = currentConfig.customizations[group.id];
    const option = group.options.find(o => o.id === selectedOptId);
    if (option) {
      price += option.priceAdj;
    }
  });
  
  currentConfig.price = Math.max(0, Math.round(price));
  currentConfig.leadTime = model.leadTimeDays;
  
  document.getElementById('configPrice').textContent = currentConfig.price.toLocaleString();
  document.getElementById('configLeadtime').textContent = model.leadTimeDays + ' days';
}

function saveConfiguration() {
  if (!currentConfig.modelId) {
    alert('Please select a model first');
    return;
  }
  
  const configJSON = JSON.stringify(currentConfig, null, 2);
  const blob = new Blob([configJSON], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `config-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üíæ Configuration saved to file!');
}

function addConfigToCart() {
  if (!currentConfig.modelId) {
    alert('Please select a model first');
    return;
  }
  
  const model = CONFIGURATOR_MODELS.find(m => m.id === currentConfig.modelId);
  const qtyLabel = currentConfig.quantity > 1 ? ` √ó ${currentConfig.quantity}` : '';
  const configName = `${model.name} (${currentConfig.width}mm, RAL ${currentConfig.panelColor})${qtyLabel}`;
  
  const cartItem = {
    id: Date.now(),
    name: configName,
    price: currentConfig.price,
    qty: currentConfig.quantity || 1,
    config: JSON.parse(JSON.stringify(currentConfig))
  };
  
  cart.push(cartItem);
  updateCart();
  showToast('‚úÖ Configuration added to cart!');
  setTimeout(() => showStorefront(), 1000);
}

// ======= STOREFRONT =======
function getFiltered() {
  let list = currentFilter === 'All' ? [...products] : products.filter(p => p.category === currentFilter);
  const q = (document.getElementById('searchInput') ? document.getElementById('searchInput').value : '').toLowerCase();
  if (q) list = list.filter(p => p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q));
  if (currentSort === 'price-asc') list.sort((a,b) => a.price - b.price);
  else if (currentSort === 'price-desc') list.sort((a,b) => b.price - a.price);
  else if (currentSort === 'name') list.sort((a,b) => a.name.localeCompare(b.name));
  return list;
}

function renderProducts(list) {
  const countEl = document.getElementById('productCount');
  if (countEl) countEl.textContent = list.length + ' items';
  const grid = document.getElementById('productGrid');
  if (!grid) return;
  if (!list.length) { grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--muted);padding:48px 0;font-size:16px;">No products found.</p>'; return; }
  grid.innerHTML = list.map(p => `
    <div class="product-card" onclick="openModal(${p.id})">
      <div class="product-img">
        ${p.images.length ? `<img src="${p.images[0]}" alt="${p.name}">` : `<span class="placeholder-icon">${p.icon}</span>`}
        ${p.badge ? `<span class="product-badge">${p.badge}</span>` : ''}
      </div>
      <div class="product-info">
        <div class="product-category">${p.category}</div>
        <div class="product-name">${p.name}</div>
        <div class="product-desc">${p.desc}</div>
        <div class="product-footer">
          <div class="product-price">$${p.price.toLocaleString()}</div>
          <button class="add-to-cart" onclick="event.stopPropagation();addToCart(${p.id})">Add to Cart</button>
        </div>
      </div>
    </div>`).join('');
}

function setFilter(cat, btn) {
  currentFilter = cat;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.nav-inner a').forEach(a => a.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const title = document.getElementById('sectionTitle');
  if (title) title.textContent = cat === 'All' ? 'Featured Equipment' : cat + ' Equipment';
  renderProducts(getFiltered());
}

function openModal(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  currentProduct = p;
  document.getElementById('modalTitle').textContent = p.name;
  document.getElementById('modalCat').textContent = p.category;
  document.getElementById('modalName').textContent = p.name;
  document.getElementById('modalPrice').textContent = '$' + p.price.toLocaleString();
  document.getElementById('modalDesc').textContent = p.desc;
  document.getElementById('modalSpecs').innerHTML = '<h4>Specifications</h4>' + p.specs.map(s => `<div class="spec-row"><span class="spec-key">${s.k}</span><span class="spec-val">${s.v}</span></div>`).join('');
  const main = document.getElementById('modalMainImg');
  main.innerHTML = p.images.length ? `<img src="${p.images[0]}">` : `<span style="font-size:72px">${p.icon}</span>`;
  const thumbs = document.getElementById('modalThumbs');
  thumbs.innerHTML = p.images.slice(0,4).map((src,i) => `<div class="modal-thumb ${i===0?'active':''}" onclick="switchImg('${src}',this)"><img src="${src}"></div>`).join('');
  document.getElementById('modalCartBtn').onclick = () => addToCart(p.id);
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function switchImg(src, el) {
  document.getElementById('modalMainImg').innerHTML = `<img src="${src}">`;
  document.querySelectorAll('.modal-thumb').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

function downloadSpec() {
  if (!currentProduct) return;
  const p = currentProduct;
  let c = `SPECIFICATION SHEET\n${'='.repeat(50)}\n\nProduct: ${p.name}\nCategory: ${p.category}\nSKU: ${p.sku||'N/A'}\nPrice: $${p.price.toLocaleString()}\n\nDESCRIPTION\n${'-'.repeat(30)}\n${p.desc}\n\nSPECIFICATIONS\n${'-'.repeat(30)}\n`;
  p.specs.forEach(s => c += `${s.k}: ${s.v}\n`);
  c += `\n${'='.repeat(50)}\nEquipment Design & Planning Inc. | (800) 555-0192`;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([c], {type:'text/plain'}));
  a.download = p.name.replace(/\s+/g,'_') + '_SpecSheet.txt';
  a.click();
  showToast('üìÑ Spec sheet downloaded!');
}

function addToCart(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  const ex = cart.find(c => c.id === id);
  ex ? ex.qty++ : cart.push({...p, qty:1});
  updateCart();
  showToast('‚úÖ ' + p.name + ' added to cart!');
}

function removeFromCart(id) { cart = cart.filter(c => c.id !== id); updateCart(); }

function updateCart() {
  document.getElementById('cartBadge').textContent = cart.reduce((s,i) => s+i.qty, 0);
  const el = document.getElementById('cartItems');
  el.innerHTML = cart.length ? cart.map(i => `
    <div class="cart-item">
      <div class="cart-item-img">${i.images.length ? `<img src="${i.images[0]}">` : i.icon}</div>
      <div class="cart-item-info">
        <div class="cart-item-name">${i.name}</div>
        <div class="cart-item-price">$${i.price.toLocaleString()} √ó ${i.qty}</div>
      </div>
      <button class="cart-item-remove" onclick="removeFromCart(${i.id})">‚úï</button>
    </div>`).join('') : '<div class="cart-empty">Your cart is empty.</div>';
  document.getElementById('cartTotal').textContent = '$' + cart.reduce((s,i) => s+i.price*i.qty, 0).toLocaleString();
}

function toggleCart() {
  document.getElementById('cartDrawer').classList.toggle('open');
  document.getElementById('cartOverlay').classList.toggle('open');
}

function handleImages(input) {
  Array.from(input.files).forEach(file => {
    const r = new FileReader();
    r.onload = e => { uploadedImages.push(e.target.result); renderPreviews(); };
    r.readAsDataURL(file);
  });
}

function renderPreviews() {
  document.getElementById('imgPreviews').innerHTML = uploadedImages.map((src,i) => `
    <div class="img-preview"><img src="${src}"><button class="del-img" onclick="uploadedImages.splice(${i},1);renderPreviews()">‚úï</button></div>`).join('');
}

function addSpec() {
  const row = document.createElement('div');
  row.className = 'spec-row-input';
  row.innerHTML = `<input type="text" placeholder="Spec name" class="spec-key"><input type="text" placeholder="Value" class="spec-val"><button class="remove-spec" onclick="this.parentElement.remove()">‚úï</button>`;
  document.getElementById('specRows').appendChild(row);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
